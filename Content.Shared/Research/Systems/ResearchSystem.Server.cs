using Content.Shared.Research.Components;
using System.Linq;

namespace Content.Shared.Research.Systems;

public partial class ResearchSystem
{
    private void InitializeServer()
    {
        SubscribeLocalEvent<ResearchServerComponent, ComponentStartup>(OnServerStartup);
        SubscribeLocalEvent<ResearchServerComponent, ComponentShutdown>(OnServerShutdown);
        SubscribeLocalEvent<ResearchServerComponent, TechnologyDatabaseModifiedEvent>(OnServerDatabaseModified);
    }

    private void OnServerStartup(Entity<ResearchServerComponent> ent, ref ComponentStartup args)
    {
        var unusedId = EntityQuery<ResearchServerComponent>(true)
            .Max(s => s.Id) + 1;
        ent.Comp.Id = unusedId;
        Dirty(ent);
    }

    private void OnServerShutdown(Entity<ResearchServerComponent> ent, ref ComponentShutdown args)
    {
        foreach (var client in new List<EntityUid>(ent.Comp.Clients))
        {
            UnregisterClient(client, ent.AsNullable(), dirtyServer: false);
        }
    }

    private void OnServerDatabaseModified(Entity<ResearchServerComponent> ent, ref TechnologyDatabaseModifiedEvent args)
    {
        foreach (var client in ent.Comp.Clients)
        {
            RaiseLocalEvent(client, ref args);
        }
    }

    private bool CanRun(EntityUid uid)
    {
        return _power.IsPowered(uid);
    }

    private void UpdateServer(Entity<ResearchServerComponent?> ent, int time)
    {
        if (!Resolve(ent, ref ent.Comp))
            return;

        if (!CanRun(ent))
            return;
        ModifyServerPoints(ent, GetPointsPerSecond(ent) * time);
    }

    /// <summary>
    /// Registers a client to the specified server.
    /// </summary>
    /// <param name="client">The client being registered</param>
    /// <param name="server">The server the client is being registered to</param>
    /// <param name="dirtyServer">Whether or not to dirty the server component after registration</param>
    public void RegisterClient(Entity<ResearchClientComponent?> client, Entity<ResearchServerComponent?> server, bool dirtyServer = true)
    {
        if (!Resolve(client, ref client.Comp, false) || !Resolve(server, ref server.Comp, false))
            return;

        if (server.Comp.Clients.Contains(client))
            return;

        server.Comp.Clients.Add(client);
        client.Comp.Server = server;
        SyncClientWithServer(client.Owner);

        if (dirtyServer && !TerminatingOrDeleted(server))
            Dirty(server);

        var ev = new ResearchRegistrationChangedEvent(server);
        RaiseLocalEvent(client, ref ev);
    }

    /// <summary>
    /// Unregisters a client from its server
    /// </summary>
    /// <param name="client">The client being unregistered</param>
    /// <param name="server">The server the client is being unregistered to</param>
    /// <param name="dirtyServer">Whether or not to dirty the server component after unregistration</param>
    public void UnregisterClient(Entity<ResearchClientComponent> ent, bool dirtyServer = true)
    {
        if (ent.Comp.Server is not { } server)
            return;

        UnregisterClient(ent.AsNullable(), server, dirtyServer: dirtyServer);
    }

    /// <summary>
    /// Unregisters a client from its server
    /// </summary>
    /// <param name="client">The client being unregistered</param>
    /// <param name="server">The server the client is being unregistered to</param>
    /// <param name="dirtyServer">Whether or not to dirty the server component after unregistration</param>
    public void UnregisterClient(Entity<ResearchClientComponent?> client, Entity<ResearchServerComponent?> server, bool dirtyServer = true)
    {
        if (!Resolve(client, ref client.Comp, false) || !Resolve(server, ref server.Comp, false))
            return;

        server.Comp.Clients.Remove(client);
        client.Comp.Server = null;
        SyncClientWithServer(client.Owner);

        if (dirtyServer && !TerminatingOrDeleted(server))
        {
            Dirty(server);
        }

        var ev = new ResearchRegistrationChangedEvent(null);
        RaiseLocalEvent(client, ref ev);
    }

    /// <summary>
    /// Gets the amount of points generated by all the server's sources in a second.
    /// </summary>
    /// <param name="uid"></param>
    /// <param name="component"></param>
    /// <returns></returns>
    public int GetPointsPerSecond(Entity<ResearchServerComponent?> ent)
    {
        var points = 0;

        if (!Resolve(ent, ref ent.Comp))
            return points;

        if (!CanRun(ent))
            return points;

        var ev = new ResearchServerGetPointsPerSecondEvent(ent, points);
        foreach (var client in ent.Comp.Clients)
        {
            RaiseLocalEvent(client, ref ev);
        }
        return ev.Points;
    }

    /// <summary>
    /// Adds a specified number of points to a server.
    /// </summary>
    /// <param name="uid">The server</param>
    /// <param name="points">The amount of points being added</param>
    /// <param name="component"></param>
    public void ModifyServerPoints(Entity<ResearchServerComponent?> ent, int points)
    {
        if (points == 0)
            return;

        if (!Resolve(ent, ref ent.Comp))
            return;

        ent.Comp.Points += points;
        var ev = new ResearchServerPointsChangedEvent(ent, ent.Comp.Points, points);
        foreach (var client in ent.Comp.Clients)
        {
            RaiseLocalEvent(client, ref ev);
        }
        Dirty(ent);
    }
}
