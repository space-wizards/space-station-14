using System.Linq;
using System.Numerics;
using Content.Client.UserInterface.Controls;
using Content.Shared.Atmos;
using Content.Shared.Chemistry.Reagent;
using Content.Shared.Damage.Components;
using Content.Shared.EntityConditions.Conditions;
using Content.Shared.FixedPoint;
using Content.Shared.Medical.Cryogenics;
using Content.Shared.Temperature;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.CustomControls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Prototypes;
namespace Content.Client.Medical.Cryogenics;

[GenerateTypedNameReferences]
public sealed partial class CryoPodWindow : FancyWindow
{
    [Dependency] private readonly IEntityManager _entityManager = default!;
    [Dependency] private readonly IPrototypeManager _prototypeManager = default!;

    public event Action? OnEjectPressed;
    public event Action? OnInjectPressed;

    public CryoPodWindow()
    {
        IoCManager.InjectDependencies(this);
        RobustXamlLoader.Load(this);
        EjectButton.OnPressed += _ => OnEjectPressed?.Invoke();
        InjectButton.OnPressed += _ => OnInjectPressed?.Invoke();
    }

    public void Populate(CryoPodUserMessage msg)
    {
        InvalidateMeasure();

        // Loading screen
        if (LoadingPlaceHolder.Visible)
        {
            LoadingPlaceHolder.Visible = false;
            Content.Visible = true;
        }

        // Atmosphere
        bool showsPressureWarning = (msg.GasMix.Pressure < Atmospherics.WarningLowPressure);
        bool hasGas = (msg.GasMix.Pressure > Atmospherics.GasMinMoles);
        LowPressureWarning.Visible = showsPressureWarning;
        Pressure.Text = Loc.GetString("gas-analyzer-window-pressure-val-text",
                                      ("pressure", $"{msg.GasMix.Pressure:0.00}"));
        Temperature.Text = Loc.GetString("gas-analyzer-window-not-available");

        if (hasGas)
        {
            var celsius = TemperatureHelpers.KelvinToCelsius(msg.GasMix.Temperature);
            Temperature.Text = Loc.GetString("gas-analyzer-window-temperature-val-text",
                                             ("tempK", $"{msg.GasMix.Temperature:0.0}"),
                                             ("tempC", $"{celsius:0.0}"));
        }

        // Gas mix segmented bar chart
        GasMixChart.Clear();
        GasMixChart.Visible = hasGas;

        if (msg.GasMix.Gases != null)
        {
            var totalGasAmount = msg.GasMix.Gases.Sum(gas => gas.Amount);

            foreach (var gas in msg.GasMix.Gases)
            {
                var color = Color.FromHex($"#{gas.Color}", Color.White);
                var percent = gas.Amount / totalGasAmount * 100;
                var localizedName = Loc.GetString(gas.Name);
                var tooltip = Loc.GetString("gas-analyzer-window-molarity-percentage-text",
                                            ("gasName", localizedName),
                                            ("amount", $"{gas.Amount:0.##}"),
                                            ("percentage", $"{percent:0.#}"));
                GasMixChart.AddEntry(gas.Amount, color, tooltip: tooltip);
            }
        }

        // Health analyzer
        var maybePatient = _entityManager.GetEntity(msg.Health.TargetEntity);
        bool hasPatient = msg.Health.TargetEntity.HasValue;
        bool hasDamage = (hasPatient
             && _entityManager.TryGetComponent(maybePatient, out DamageableComponent? damageable)
             && damageable.TotalDamage > 0);

        NoDamageText.Visible = (hasPatient && !hasDamage);
        HealthAnalyzer.Visible = hasPatient;
        NoPatientText.Visible = !hasPatient;
        EjectButton.Disabled = !hasPatient;

        if (hasPatient)
            HealthAnalyzer.Populate(msg.Health);

        // Reagents
        bool hasBeaker = (msg.Beaker != null);
        NoBeakerText.Visible = !hasBeaker;
        ChemicalsInfo.Visible = hasBeaker;

        float? lowestTempRequirement = null;
        ReagentId? lowestTempReagent = null;
        var availableQuantity = new FixedPoint2();
        var injectingQuantity = new FixedPoint2();

        if (hasBeaker)
        {
            foreach (var (reagent, quantity) in msg.Beaker!)
            {
                availableQuantity += quantity;

                var temp = TryFindMaxTemperatureRequirement(reagent);
                if (lowestTempRequirement == null
                    || temp < lowestTempRequirement)
                {
                    lowestTempRequirement = temp;
                    lowestTempReagent = reagent;
                }
            }
        }

        if (msg.Injecting != null)
        {
            foreach (var (_, quantity) in msg.Injecting!)
            {
                injectingQuantity += quantity;
            }
        }

        AvailableQuantity.Text = $"{availableQuantity:F1}u";
        InjectingQuantity.Text = $"{injectingQuantity:F1}u";
        InjectButton.Disabled = (!hasPatient || availableQuantity < 0.1f);

        // Temperature warning
        bool showsTemperatureWarning =
            (!showsPressureWarning
             && lowestTempRequirement != null
             && lowestTempRequirement < msg.GasMix.Temperature);

        HighTemperatureWarning.Visible = showsTemperatureWarning;

        if (showsTemperatureWarning)
        {
            var reagentName = _prototypeManager.Index<ReagentPrototype>(lowestTempReagent!.Value.Prototype)
                                               .LocalizedName;
            HighTemperatureWarningText.Text = Loc.GetString("cryo-pod-window-high-temperature-warning",
                ("reagent", reagentName),
                ("temperature", lowestTempRequirement!));
        }
    }

    private float? TryFindMaxTemperatureRequirement(ReagentId reagent)
    {
        var reagentProto = _prototypeManager.Index<ReagentPrototype>(reagent.Prototype);
        if (reagentProto.Metabolisms == null)
            return null;

        float? result = null;

        foreach (var (_, metabolism) in reagentProto.Metabolisms)
        {
            foreach (var effect in metabolism.Effects)
            {
                if (effect.Conditions == null)
                    continue;

                foreach (var condition in effect.Conditions)
                {
                    // If there are multiple temperature conditions in the same reagent (which could hypothetically
                    // happen, although it currently doesn't), we return the lowest max temperature.
                    if (condition is TemperatureCondition tempCondition
                        && float.IsFinite(tempCondition.Max)
                        && (result == null || tempCondition.Max < result))
                    {
                        result = tempCondition.Max;
                    }
                }
            }
        }

        return result;
    }

    public void SetEjectErrorVisible(bool isVisible)
    {
        EjectError.Visible = isVisible;
    }

    protected override Vector2 MeasureOverride(Vector2 availableSize)
    {
        // Here we make sure that the DesiredSize of the tabs is initialized to a reasonable size, but we invalidate
        // it again afterwards so that it will still be calculated the normal way.
        Content.Measure(availableSize);
        Content.InvalidateMeasure();

        // Note that Content is inside of a ScrollContainer, so by default its DesiredSize is ignored. We instead want
        // the window size to be the content size, but clamped between Min & MaxSize (the ScrollContainer is there to
        // make it work nicely when it's clamped by MaxSize).
        // We add extra space for FancyWindow decorations.
        return Content.DesiredSize + new Vector2(10, 50);
    }
}
