using System.Linq;
using System.Numerics;
using Content.Shared.Atmos;
using Content.Shared.Chemistry.Reagent;
using Content.Shared.EntityConditions.Conditions;
using Content.Shared.FixedPoint;
using Content.Shared.Medical.Cryogenics;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.CustomControls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Prototypes;
namespace Content.Client.Medical.Cryogenics;

[GenerateTypedNameReferences]
public sealed partial class CryoPodWindow : DefaultWindow
{
    [Dependency] private readonly IPrototypeManager _prototypeManager = default!;

    public event Action? OnEjectPressed;

    public CryoPodWindow()
    {
        IoCManager.InjectDependencies(this);
        RobustXamlLoader.Load(this);
        EjectButton.OnPressed += _ => OnEjectPressed?.Invoke();
        Tabs.SetTabTitle(0, "Medical");
        Tabs.SetTabTitle(1, "Atmosphere");
    }

    public void Populate(CryoPodUserMessage msg)
    {
        InvalidateMeasure();

        // Loading screen
        if (LoadingPlaceHolder.Visible)
        {
            LoadingPlaceHolder.Visible = false;
            PatientTabContent.Visible = true;
        }

        // Gas analyzer
        bool showsPressureWarning = (msg.GasMix.Pressure < Atmospherics.WarningLowPressure);
        LowPressureWarning.Visible = showsPressureWarning;
        GasMix.Populate(msg.GasMix);

        // Health analyzer
        bool hasPatient = msg.Health.TargetEntity.HasValue;
        HealthAnalyzer.Visible = hasPatient;
        NoPatientText.Visible = !hasPatient;
        EjectButton.Disabled = !hasPatient;

        if (hasPatient)
            HealthAnalyzer.Populate(msg.Health);

        // Reagents
        float? lowestTempRequirement = null;
        ReagentId? lowestTempReagent = null;
        bool hasBeaker = (msg.Beaker != null);
        NoBeakerText.Visible = !hasBeaker;
        ChemicalsInfo.Visible = hasBeaker;
        // TODO InjectingBox.Visible = hasBeaker;

        if (hasBeaker)
        {
            var available = new FixedPoint2();

            foreach (var (reagent, quantity) in msg.Beaker!)
            {
                available += quantity;

                var temp = TryFindMaxTemperatureRequirement(reagent);
                if (lowestTempRequirement == null
                    || temp < lowestTempRequirement)
                {
                    lowestTempRequirement = temp;
                    lowestTempReagent = reagent;
                }
            }

            AvailableQuantity.Text = $"{available:F1}u";
        }

        // Temperature warning
        bool showsTemperatureWarning =
            (!showsPressureWarning
             && lowestTempRequirement != null
             && lowestTempRequirement < msg.GasMix.Temperature);

        HighTemperatureWarning.Visible = showsTemperatureWarning;

        if (showsTemperatureWarning)
        {
            var reagentName = _prototypeManager.Index<ReagentPrototype>(lowestTempReagent!.Value.Prototype)
                                               .LocalizedName;
            HighTemperatureWarningText.Text = Loc.GetString("cryo-pod-window-high-temperature-warning",
                ("reagent", reagentName),
                ("temperature", lowestTempRequirement!));
        }
    }

    private float? TryFindMaxTemperatureRequirement(ReagentId reagent)
    {
        var reagentProto = _prototypeManager.Index<ReagentPrototype>(reagent.Prototype);
        if (reagentProto.Metabolisms == null)
            return null;

        float? result = null;

        foreach (var (_, metabolism) in reagentProto.Metabolisms)
        {
            foreach (var effect in metabolism.Effects)
            {
                if (effect.Conditions == null)
                    continue;

                foreach (var condition in effect.Conditions)
                {
                    // If there are multiple temperature conditions in the same reagent (which could hypothetically
                    // happen, although it currently doesn't), we return the lowest max temperature.
                    if (condition is TemperatureCondition tempCondition
                        && float.IsFinite(tempCondition.Max)
                        && (result == null || tempCondition.Max < result))
                    {
                        result = tempCondition.Max;
                    }
                }
            }
        }

        return result;
    }

    public void SetEjectErrorVisible(bool isVisible)
    {
        EjectError.Visible = isVisible;
    }

    protected override Vector2 MeasureOverride(Vector2 availableSize)
    {
        // Here we make sure that the DesiredSize of the tabs is initialized to a reasonable size, but we invalidate
        // it again afterwards so that it will still be calculated the normal way.
        PatientTabContent.Measure(availableSize);
        GasMixTabContent.Measure(availableSize);
        PatientTabContent.InvalidateMeasure();
        GasMixTabContent.InvalidateMeasure();

        // The DesiredSize of the window is the size of the bigger tab.
        var tab1Size = PatientTabContent.DesiredSize;
        var tab2Size = GasMixTabContent.DesiredSize;
        var contentSize = Vector2.Max(tab1Size, tab2Size)
            + new Vector2(50, 100);  // Extra space for margins, tabs and scrollbar.
        return contentSize;
    }
}
