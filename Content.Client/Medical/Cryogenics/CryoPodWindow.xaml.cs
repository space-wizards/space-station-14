using System.Numerics;
using Content.Shared.Medical.Cryogenics;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.CustomControls;
using Robust.Client.UserInterface.XAML;
namespace Content.Client.Medical.Cryogenics;

[GenerateTypedNameReferences]
public sealed partial class CryoPodWindow : DefaultWindow
{
    public event Action? OnEjectPressed;

    public CryoPodWindow()
    {
        RobustXamlLoader.Load(this);
        EjectButton.OnPressed += _ => OnEjectPressed?.Invoke();
        Tabs.SetTabTitle(0, "Medical");
        Tabs.SetTabTitle(1, "Atmosphere");
    }

    public void Populate(CryoPodUserMessage msg)
    {
        InvalidateMeasure();

        // Gas analyzer
        LowPressureWarning.Visible = msg.GasMix.Pressure < Atmospherics.WarningLowPressure;
        GasMix.Populate(msg.GasMix);

        // Health analyzer
        bool hasPatient = msg.Health.TargetEntity.HasValue;
        HealthAnalyzer.Visible = hasPatient;
        NoPatientText.Visible = !hasPatient;
        EjectButton.Disabled = !hasPatient;

        if (hasPatient)
            HealthAnalyzer.Populate(msg.Health);
    }

    public void SetEjectErrorVisible(bool isVisible)
    {
        EjectError.Visible = isVisible;
    }

    protected override Vector2 MeasureOverride(Vector2 availableSize)
    {
        // Here we make sure that the DesiredSize of the tabs is initialized to a reasonable size, but we invalidate
        // it again afterwards so that it will still be calculated the normal way.
        PatientTabContent.Measure(availableSize);
        GasMixTabContent.Measure(availableSize);
        PatientTabContent.InvalidateMeasure();
        GasMixTabContent.InvalidateMeasure();

        // The DesiredSize of the window is the size of the bigger tab.
        var tab1Size = PatientTabContent.DesiredSize;
        var tab2Size = GasMixTabContent.DesiredSize;
        var contentSize = Vector2.Max(tab1Size, tab2Size)
            + new Vector2(50, 100);  // Extra space for margins, tabs and scrollbar.
        return contentSize;
    }
}
