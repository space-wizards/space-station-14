using System.Linq;
using Content.Client.UserInterface.Controls;
using Content.Shared.Decals;
using Robust.Client.AutoGenerated;
using Robust.Client.GameObjects;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.CustomControls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Prototypes;
using Robust.Shared.Utility;

namespace Content.Client.SprayPainter.UI;

[GenerateTypedNameReferences]
public sealed partial class SprayPainterWindow : DefaultWindow
{
    [Dependency] private readonly IEntitySystemManager _sysMan = default!;
    [Dependency] private readonly ILocalizationManager _loc = default!;

    private readonly SpriteSystem _spriteSystem;

    // Events
    public Action<string, int>? OnSpritePicked;
    public Action<int, bool>? OnTabChanged;
    public Action<ProtoId<DecalPrototype>>? OnDecalChanged;
    public Action<ItemList.ItemListSelectedEventArgs>? OnColorPicked;
    public Action<Color?>? OnDecalColorChanged;
    public Action<int>? OnDecalAngleChanged;

    private ItemList _colorList = default!;
    public Dictionary<string, int> ItemColorIndex = new();

    private Dictionary<string, Color> _currentPalette = new();
    private const string ColorLocKeyPrefix = "pipe-painter-color-";
    private Dictionary<string, List<SprayPainterEntry>> _currentEntries = new();

    // Decals
    private List<SprayPainterDecalEntry> _currentDecals = [];
    private SprayPainterDecals? _sprayPainterDecals;

    private readonly SpriteSpecifier _colorEntryIconTexture = new SpriteSpecifier.Rsi(
        new ResPath("Structures/Piping/Atmospherics/pipe.rsi"),
        "pipeStraight");

    public SprayPainterWindow()
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);
        _spriteSystem = _sysMan.GetEntitySystem<SpriteSystem>();
        Tabs.OnTabChanged += (index) => OnTabChanged?.Invoke(index, _sprayPainterDecals?.GetPositionInParent() == index);
    }

    private string GetColorLocString(string? colorKey)
    {
        if (string.IsNullOrEmpty(colorKey))
            return Loc.GetString("pipe-painter-no-color-selected");
        var locKey = ColorLocKeyPrefix + colorKey;

        if (!_loc.TryGetString(locKey, out var locString))
            locString = colorKey;

        return locString;
    }

    public string? IndexToColorKey(int index)
    {
        return (string?)_colorList[index].Metadata;
    }

    private void OnItemSelected(BaseButton.ButtonEventArgs args, ListData data)
    {
        if (data is SpriteListData listData && args.Button is ListContainerButton button)
            OnSpritePicked?.Invoke(listData.Category, button.Index);
    }

    public void Populate(Dictionary<string, List<SprayPainterEntry>> entries,
        Dictionary<string, int> selectedStyles,
        List<SprayPainterDecalEntry> decals,
        string? selectedColorKey,
        Dictionary<string, Color> palette,
        int tabIndex)
    {
        // Only clear if the entries change. Otherwise the list would "jump" after selecting an item
        if (!_currentEntries.Equals(entries))
        {
            _currentEntries = entries;

            foreach (var (category, indexCategory) in entries.Keys.OrderBy(x => x).Select((x, i) => (x, i)))
            {
                var box = new BoxContainer() { Orientation = BoxContainer.LayoutOrientation.Vertical };
                var label = new Label() { Text = Loc.GetString("spray-painter-selected-style") };

                var spriteList = new ListContainer()
                {
                    Toggle = true,
                    Group = true,
                    GenerateItem = GenerateItems,
                };
                var dataList = entries[category]
                    .Select(e => new SpriteListData(category, e.Name, e.Proto, selectedStyles[category]))
                    .ToList();
                spriteList.PopulateList(dataList);
                spriteList.ItemPressed += OnItemSelected;

                box.AddChild(label);
                box.AddChild(spriteList);
                Tabs.AddChild(box);

                if (indexCategory == tabIndex)
                {
                    Tabs.CurrentTab = indexCategory;
                }

                var tabLocalization = Loc.GetString("spray-painter-tabs-" + category.ToLower());
                TabContainer.SetTabTitle(box, tabLocalization);
            }
        }

        if (!_currentPalette.Equals(palette))
        {
            _currentPalette = palette;
            ItemColorIndex.Clear();

            _colorList = new ItemList() { VerticalExpand = true };
            var label = new Label() { Text = Loc.GetString("spray-painter-selected-color") };
            var box = new BoxContainer() { Orientation = BoxContainer.LayoutOrientation.Vertical };

            box.AddChild(label);
            box.AddChild(_colorList);

            Tabs.AddChild(box);
            TabContainer.SetTabTitle(box, Loc.GetString("spray-painter-tabs-pipes"));

            foreach (var color in palette)
            {
                var locString = GetColorLocString(color.Key);
                var item = _colorList.AddItem(locString, _spriteSystem.Frame0(_colorEntryIconTexture));
                item.IconModulate = color.Value;
                item.Metadata = color.Key;

                ItemColorIndex.Add(color.Key, _colorList.IndexOf(item));
            }
        }

        if (!_currentDecals.Equals(decals))
        {
            _currentDecals = decals;

            if (_sprayPainterDecals is null)
            {
                _sprayPainterDecals = new SprayPainterDecals();

                _sprayPainterDecals.OnDecalSelected += id => OnDecalChanged?.Invoke(id);
                _sprayPainterDecals.OnColorChanged += color => OnDecalColorChanged?.Invoke(color);
                _sprayPainterDecals.OnAngleChanged += angle => OnDecalAngleChanged?.Invoke(angle);

                Tabs.AddChild(_sprayPainterDecals);
                TabContainer.SetTabTitle(_sprayPainterDecals, Loc.GetString("spray-painter-tabs-decals"));
            }

            _sprayPainterDecals.PopulateDecals(decals, _spriteSystem);
        }

        var index = ItemColorIndex[selectedColorKey ?? _currentPalette.Keys.First()];
        _colorList[index].Selected = true;
        _colorList.OnItemSelected += OnColorPicked;
    }

    private void GenerateItems(ListData data, ListContainerButton button)
    {
        if (data is not SpriteListData spriteListData)
            return;

        var box = new BoxContainer() { Orientation = BoxContainer.LayoutOrientation.Horizontal };
        var protoView = new EntityPrototypeView();
        protoView.SetPrototype(spriteListData.Prototype);
        var label = new Label()
            { Text = Loc.GetString($"spray-painter-style-{spriteListData.Category.ToLower()}-{spriteListData.Style}") };

        box.AddChild(protoView);
        box.AddChild(label);
        button.AddChild(box);
        button.AddStyleClass(ListContainer.StyleClassListContainerButton);

        if (spriteListData.SelectedIndex == button.Index)
            button.Pressed = true;
    }
}

record SpriteListData(string Category, string Style, EntProtoId? Prototype, int SelectedIndex) : ListData;
