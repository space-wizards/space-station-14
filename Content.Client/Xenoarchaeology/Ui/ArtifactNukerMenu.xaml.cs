using Content.Client.UserInterface.Controls;
using Content.Shared.Xenoarchaeology.Equipment.Components;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;

namespace Content.Client.Xenoarchaeology.Ui;

[GenerateTypedNameReferences]
public sealed partial class ArtifactNukerMenu : FancyWindow
{
    [Dependency] private readonly IEntityManager _entity = default!;
    public Action<string>? IndexChanged;
    private string _validIndex;
    public EntityUid Entity;

    public ArtifactNukerMenu()
    {
        RobustXamlLoader.Load(this);

        IoCManager.InjectDependencies(this);

        _validIndex = IndexLineEdit.Text;

        IndexLineEdit.OnTextChanged += OnIndexChanged;
        IndexLineEdit.OnTextEntered += OnIndexEnter;
        IndexLineEdit.OnFocusExit += OnNameFocusExit;
    }

    public void GetIndex(EntityUid entity)
    {
        Entity = entity;

        if (_entity.TryGetComponent<ArtifactNukerComponent>(Entity, out var nuker) &&
            nuker.Index is not null)
        {
            IndexLineEdit.Text = nuker.Index;
        }
    }

    private void OnIndexChanged(LineEdit.LineEditEventArgs obj)
    {
        if (!int.TryParse(obj.Text, out _) &&
            !string.IsNullOrEmpty(obj.Text))
        {
            obj.Control.Text = _validIndex;
            return;
        }

        _validIndex = obj.Control.Text;
        obj.Control.Text = _validIndex;
    }

    private void OnIndexEnter(LineEdit.LineEditEventArgs obj)
    {
        IndexChanged?.Invoke(_validIndex);
    }

    private void OnNameFocusExit(LineEdit.LineEditEventArgs obj)
    {
        if (!int.TryParse(obj.Text, out _) ||
            !string.IsNullOrEmpty(obj.Text))
        {
            obj.Control.Text = _validIndex;
            return;
        }

        IndexChanged?.Invoke(_validIndex);
    }
}
