using System.Numerics;
using Content.Shared.Communications;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.CustomControls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Prototypes;

namespace Content.Client.Communications.UI;

[GenerateTypedNameReferences]
public sealed partial class CommunicationsConsoleMenu : BaseWindow
{
    private const int DragMoveSize = 40;
    private const int DragResizeSize = 7;

    public event Action? OnShuttleCalled;
    public event Action? OnShuttleRecalled;
    public event Action<string>? OnAlertLevelChanged;
    public event Action<string>? OnRadioAnnounce;
    public event Action<string>? OnScreenBroadcast;

    public CommunicationsConsoleMenu()
    {
        IoCManager.InjectDependencies(this);
        RobustXamlLoader.Load(this);

        CloseButton.OnPressed += _ => Close();

        MessagingControls.OnRadioAnnounce += message => OnRadioAnnounce?.Invoke(message);
        MessagingControls.OnScreenBroadcast += message => OnScreenBroadcast?.Invoke(message);

        AlertLevelControls.OnAlertLevelChanged += newLevel => OnAlertLevelChanged?.Invoke(newLevel);

        ShuttleControls.OnShuttleCalled += () => OnShuttleCalled?.Invoke();
        ShuttleControls.OnShuttleRecalled += () => OnShuttleRecalled?.Invoke();
    }

    /// <summary>
    /// Use the specified prototype ID as an example display in the
    /// UI subsection where users type broadcast messages
    /// </summary>
    public void SetBroadcastDisplayEntity(EntProtoId broadcastEntityId)
    {
        MessagingControls.SetBroadcastDisplayEntity(broadcastEntityId);
    }

    /// <summary>
    /// Configure UI to be consistent with the input state
    /// </summary>
    public void UpdateState(CommunicationsConsoleInterfaceState commsState)
    {
        MessagingControls.CanRadioAnnounce = commsState.CanAnnounce;
        MessagingControls.CanScreenBroadcast = commsState.CanBroadcast;

        var alertLevelSelectable = commsState.AlertLevels != null && commsState.CurrentAlertDelay <= 0;
        AlertLevelControls.UpdateAlertLevels(commsState.AlertLevels, commsState.CurrentAlert, commsState.CurrentAlertColor, alertLevelSelectable);

        ShuttleControls.UpdateState(commsState.CanCall, commsState.CountdownStarted, commsState.ExpectedCountdownEnd);
    }

    protected override DragMode GetDragModeFor(Vector2 relativeMousePos)
    {
        if (relativeMousePos.Y < DragMoveSize)
        {
            return DragMode.Move;
        }
        else
        {
            var mode = DragMode.None;

            if (relativeMousePos.Y > Size.Y - DragResizeSize)
            {
                mode |= DragMode.Bottom;
            }

            if (relativeMousePos.X > Size.X - DragResizeSize)
            {
                mode |= DragMode.Right;
            }
            return mode;
        }
    }
}
