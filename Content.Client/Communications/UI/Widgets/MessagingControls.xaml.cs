using Content.Shared.CCVar;
using Content.Shared.TextScreen;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Configuration;
using Robust.Shared.Prototypes;
using Robust.Shared.Utility;

namespace Content.Client.Communications.UI.Widgets;

[GenerateTypedNameReferences]
public sealed partial class MessagingControls : TabContainer
{
    [Dependency] private readonly ILocalizationManager _loc = default!;
    [Dependency] private readonly IConfigurationManager _cfg = default!;
    [Dependency] private readonly IEntityManager _entMan = default!;

    // Entity temporarily created to display a screen preview
    private EntityUid _broadcastDisplayEntity = EntityUid.Invalid;

    public event Action<string>? OnRadioAnnounce;
    public event Action<string>? OnScreenBroadcast;

    private bool _canRadioAnnounce;
    public bool CanRadioAnnounce
    {
        set
        {
            _canRadioAnnounce = value;
            SyncButtonState();
        }
    }

    private bool _canScreenBroadcast;
    public bool CanScreenBroadcast
    {
        set
        {
            _canScreenBroadcast = value;
            SyncButtonState();
        }
    }

    public MessagingControls()
    {
        IoCManager.InjectDependencies(this);
        RobustXamlLoader.Load(this);

        RadioMessageInput.Placeholder = new Rope.Leaf(_loc.GetString("comms-console-menu-announcement-placeholder"));

        RadioMessageInput.OnTextChanged += (_) => SyncButtonState();

        AnnounceButton.OnPressed += _ =>
        {
            OnRadioAnnounce?.Invoke(Rope.Collapse(RadioMessageInput.TextRope));
        };

        var appearanceSystem = _entMan.System<SharedAppearanceSystem>();
        ScreenMessageInput.OnTextChanged += args =>
        {
            if (_broadcastDisplayEntity.IsValid())
            {
                appearanceSystem.SetData(_broadcastDisplayEntity, TextScreenVisuals.ScreenText, args.Text);
            }
        };

        BroadcastButton.OnPressed += _ =>
        {
            OnScreenBroadcast?.Invoke(ScreenMessageInput.Text);
        };

        SyncButtonState();
    }

    public void SetBroadcastDisplayEntity(EntProtoId broadcastEntityId)
    {
        _broadcastDisplayEntity = _entMan.Spawn(broadcastEntityId);
        if (_broadcastDisplayEntity.IsValid())
        {
            BroadcastEntityDisplay.SetEntity(_broadcastDisplayEntity);
        }
    }

    protected override void ExitedTree()
    {
        if (_broadcastDisplayEntity.IsValid())
        {
            _entMan.DeleteEntity(_broadcastDisplayEntity);
        }
    }

    private void SyncButtonState()
    {
        if (_canRadioAnnounce)
        {
            var maxAnnounceLength = _cfg.GetCVar(CCVars.ChatMaxAnnouncementLength);
            if (RadioMessageInput.TextLength > maxAnnounceLength)
            {
                AnnounceButton.Disabled = true;
                AnnounceButton.ToolTip = _loc.GetString("comms-console-message-too-long");
            }
            else
            {
                AnnounceButton.Disabled = false;
                AnnounceButton.ToolTip = _loc.GetString("comms-console-menu-announcement-button-tooltip");
            }
        }
        else
        {
            AnnounceButton.Disabled = true;
            AnnounceButton.ToolTip = _loc.GetString("comms-console-message-cannot-send");
        }

        BroadcastButton.Disabled = !_canScreenBroadcast;
    }
}
