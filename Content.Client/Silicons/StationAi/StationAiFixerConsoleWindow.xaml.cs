using Content.Client.UserInterface.Controls;
using Content.Shared.Lock;
using Content.Shared.Silicons.StationAi;
using Robust.Client.AutoGenerated;
using Robust.Client.Graphics;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Timing;
using Robust.Shared.Utility;
using System.Numerics;

namespace Content.Client.Silicons.StationAi;

[GenerateTypedNameReferences]
public sealed partial class StationAiFixerConsoleWindow : FancyWindow
{
    [Dependency] private readonly IEntityManager _entManager = default!;
    [Dependency] private readonly IGameTiming _timing = default!;

    private readonly StationAiFixerConsoleSystem _stationAiFixerConsole;
    private readonly SharedStationAiSystem _stationAi;

    private EntityUid? _owner;

    private readonly SpriteSpecifier.Rsi _emptyPortrait = new(new("Mobs/Silicon/station_ai.rsi"), "ai_empty");
    private readonly SpriteSpecifier.Rsi _rebootingPortrait = new(new("Mobs/Silicon/station_ai.rsi"), "ai_fuzz");
    private SpriteSpecifier? _currentPortrait;

    public event Action<StationAiFixerConsoleAction>? SendStationAiFixerConsoleMessageAction;
    public event Action? OpenConfirmationDialogAction;

    public StationAiFixerConsoleConfirmationDialog? ConfirmationDialog;

    private readonly Dictionary<StationAiState, Color> _statusColors = new()
    {
        [StationAiState.Empty] = Color.FromHex("#464966"),
        [StationAiState.Occupied] = Color.FromHex("#3E6C45"),
        [StationAiState.Rebooting] = Color.FromHex("#A5762F"),
        [StationAiState.Dead] = Color.FromHex("#BB3232"),
    };

    public StationAiFixerConsoleWindow()
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);

        _stationAiFixerConsole = _entManager.System<StationAiFixerConsoleSystem>();
        _stationAi = _entManager.System<StationAiSystem>();

        StationAiPortraitTexture.DisplayRect.TextureScale = new Vector2(4f, 4f);

        CancelButton.OnButtonDown += _ => OnSendStationAiFixerConsoleMessage(StationAiFixerConsoleAction.Cancel);
        EjectButton.OnButtonDown += _ => OnSendStationAiFixerConsoleMessage(StationAiFixerConsoleAction.Eject);
        RepairButton.OnButtonDown += _ => OnSendStationAiFixerConsoleMessage(StationAiFixerConsoleAction.Repair);
        PurgeButton.OnButtonDown += _ => OnOpenConfirmationDialog();

        CancelButton.Label.HorizontalAlignment = HAlignment.Left;
        EjectButton.Label.HorizontalAlignment = HAlignment.Left;
        RepairButton.Label.HorizontalAlignment = HAlignment.Left;
        PurgeButton.Label.HorizontalAlignment = HAlignment.Left;

        CancelButton.Label.Margin = new Thickness(40, 0, 0, 0);
        EjectButton.Label.Margin = new Thickness(40, 0, 0, 0);
        RepairButton.Label.Margin = new Thickness(40, 0, 0, 0);
        PurgeButton.Label.Margin = new Thickness(40, 0, 0, 0);
    }

    public void OnSendStationAiFixerConsoleMessage(StationAiFixerConsoleAction action)
    {
        SendStationAiFixerConsoleMessageAction?.Invoke(action);
    }

    public void OnOpenConfirmationDialog()
    {
        OpenConfirmationDialogAction?.Invoke();
    }

    public override void Close()
    {
        base.Close();
        ConfirmationDialog?.Close();
    }

    public void SetOwner(EntityUid owner)
    {
        _owner = owner;
        UpdateState();
    }

    public void UpdateState()
    {
        if (!_entManager.TryGetComponent<StationAiFixerConsoleComponent>(_owner, out var stationAiFixerConsole))
            return;

        var ent = (_owner.Value, stationAiFixerConsole);
        var isLocked = _entManager.TryGetComponent<LockComponent>(_owner, out var lockable) && lockable.Locked;

        var stationAiHolderInserted = _stationAiFixerConsole.IsStationAiHolderInserted((_owner.Value, stationAiFixerConsole));
        var stationAi = stationAiFixerConsole.ActionTarget;
        var stationAiState = StationAiState.Empty;

        if (_entManager.TryGetComponent<StationAiCustomizationComponent>(stationAi, out var stationAiCustomization))
        {
            stationAiState = stationAiCustomization.State;
        }

        // Set subscreen visibility
        LockScreen.Visible = isLocked;
        MainControls.Visible = !isLocked && !_stationAiFixerConsole.IsActionInProgress(ent);
        ActionProgressScreen.Visible = !isLocked && _stationAiFixerConsole.IsActionInProgress(ent);

        // Update station AI name
        StationAiNameLabel.Text = GetStationAiName(stationAi);
        StationAiStatusLabel.Text = Loc.GetString("station-ai-fixer-console-window-no-station-ai-status");

        // Update station AI portrait
        var portrait = _emptyPortrait;
        var statusColor = _statusColors[StationAiState.Empty];

        if (stationAiState == StationAiState.Rebooting)
        {
            portrait = _rebootingPortrait;
            StationAiStatusLabel.Text = Loc.GetString("station-ai-fixer-console-window-station-ai-rebooting");
            _statusColors.TryGetValue(StationAiState.Rebooting, out statusColor);
        }
        else if (stationAi != null &&
            stationAiCustomization != null &&
            _stationAi.TryGetCustomizedAppearanceData((stationAi.Value, stationAiCustomization), out var layerData))
        {
            StationAiStatusLabel.Text = stationAiState == StationAiState.Occupied ?
                Loc.GetString("station-ai-fixer-console-window-station-ai-online") :
                Loc.GetString("station-ai-fixer-console-window-station-ai-offline");

            if (layerData.TryGetValue(stationAiState.ToString(), out var stateData) && stateData is { RsiPath: not null, State: not null })
            {
                portrait = new SpriteSpecifier.Rsi(new ResPath(stateData.RsiPath), stateData.State);
            }

            _statusColors.TryGetValue(stationAiState, out statusColor);
        }

        if (_currentPortrait == null || !_currentPortrait.Equals(portrait))
        {
            StationAiPortraitTexture.SetFromSpriteSpecifier(portrait);
            _currentPortrait = portrait;
        }

        StationAiStatus.PanelOverride = new StyleBoxFlat
        {
            BackgroundColor = statusColor,
        };

        // Update buttons
        EjectButton.Disabled = !stationAiHolderInserted;
        RepairButton.Disabled = !stationAiHolderInserted || stationAiState != StationAiState.Dead;
        PurgeButton.Disabled = !stationAiHolderInserted || stationAiState == StationAiState.Empty;

        // Update progress bar
        if (ActionProgressScreen.Visible)
            UpdateProgressBar(ent);
    }

    public void UpdateProgressBar(Entity<StationAiFixerConsoleComponent> ent)
    {
        ActionInProgressLabel.Text = ent.Comp.ActionType == StationAiFixerConsoleAction.Repair ?
            Loc.GetString("station-ai-fixer-console-window-action-progress-repair") :
            Loc.GetString("station-ai-fixer-console-window-action-progress-purge");

        var fullTimeSpan = ent.Comp.ActionEndTime - ent.Comp.ActionStartTime;
        var remainingTimeSpan = ent.Comp.ActionEndTime - _timing.CurTime;

        var time = remainingTimeSpan.TotalSeconds > 60 ? remainingTimeSpan.TotalMinutes : remainingTimeSpan.TotalSeconds;
        var units = remainingTimeSpan.TotalSeconds > 60 ? Loc.GetString("generic-minutes") : Loc.GetString("generic-seconds");
        ActionProgressEtaLabel.Text = Loc.GetString("station-ai-fixer-console-window-action-progress-eta", ("time", (int)time), ("units", units));

        ActionProgressBar.Value = 1f - (float)remainingTimeSpan.Divide(fullTimeSpan);
    }

    private string GetStationAiName(EntityUid? uid)
    {
        if (_entManager.TryGetComponent<MetaDataComponent>(uid, out var metadata))
        {
            return metadata.EntityName;
        }

        return Loc.GetString("station-ai-fixer-console-window-no-station-ai");
    }

    protected override void FrameUpdate(FrameEventArgs args)
    {
        if (!ActionProgressScreen.Visible)
            return;

        if (!_entManager.TryGetComponent<StationAiFixerConsoleComponent>(_owner, out var stationAiFixerConsole))
            return;

        UpdateProgressBar((_owner.Value, stationAiFixerConsole));
    }
}
