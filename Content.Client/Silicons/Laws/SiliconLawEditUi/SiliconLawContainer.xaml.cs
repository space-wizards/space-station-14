using Content.Shared.Silicons.Laws;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Random;
using Robust.Shared.Utility;

namespace Content.Client.Silicons.Laws.SiliconLawEditUi;

[GenerateTypedNameReferences]
public sealed partial class SiliconLawContainer : BoxContainer
{
    [Dependency] private readonly IRobustRandom _random = default!;

    public const string StyleClassSiliconLawPositionLabel = "SiliconLawPositionLabel";

    private SiliconLaw? _law;

    public event Action<SiliconLaw>? MoveLawUp;
    public event Action<SiliconLaw>? MoveLawDown;
    public event Action<SiliconLaw>? DeleteAction;


    public SiliconLawContainer()
    {
        RobustXamlLoader.Load(this);

        MoveUp.OnPressed += _ => MoveLawUp?.Invoke(_law!);
        MoveDown.OnPressed += _ => MoveLawDown?.Invoke(_law!);
        Corrupted.OnPressed += _ =>
        {
            if (Corrupted.Pressed)
            {
                // TODO: this is copied from the ionstormsystem and should be cleaned up. these numbers should be consts
                _law!.LawIdentifierOverride = Loc.GetString("ion-storm-law-scrambled-number", ("length", _random.Next(3, 10)));
            }
            else
            {
                _law!.LawIdentifierOverride = null;
            }
        };

        LawContent.OnTextChanged += _ => _law!.LawString = Rope.Collapse(LawContent.TextRope).Trim();
        LawContent.Placeholder = new Rope.Leaf(Loc.GetString("silicon-law-ui-placeholder"));
        Delete.OnPressed += _ => DeleteAction?.Invoke(_law!);
    }

    public void SetLaw(SiliconLaw law)
    {
        _law = law;
        LawContent.TextRope = new Rope.Leaf(Loc.GetString(law.LawString));
        PositionText.Text = law.Order.ToString();
        if (!string.IsNullOrEmpty(law.LawIdentifierOverride))
        {
            Corrupted.Pressed = true;
        }
        else
        {
            Corrupted.Pressed = false;
        }
    }
}
