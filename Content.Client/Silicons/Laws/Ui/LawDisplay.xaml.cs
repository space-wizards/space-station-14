using System.Linq;
using Content.Client.Chat.Managers;
using Content.Client.Message;
using Content.Shared.Chat;
using Content.Shared.Radio;
using Content.Shared.Silicons.Laws;
using Content.Shared.Speech;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Prototypes;
using Robust.Shared.Timing;
using Robust.Shared.Utility;

namespace Content.Client.Silicons.Laws.Ui;

[GenerateTypedNameReferences]
public sealed partial class LawDisplay : Control
{
    [Dependency] private readonly IPrototypeManager _prototypeManager = default!;
    [Dependency] private readonly IChatManager _chatManager = default!;
    [Dependency] private readonly IGameTiming _timing = default!;
    [Dependency] private readonly EntityManager _entityManager = default!;

    private static readonly TimeSpan PressCooldown = TimeSpan.FromSeconds(3);

    private readonly Dictionary<int, TimeSpan> _stateLawOnCooldownUntil = [];
    private readonly Dictionary<int, Button> _stateLawButton = [];

    public LawDisplay(EntityUid uid, SiliconLaw law, bool readoutModeEnabled, HashSet<string>? radioChannels)
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);

        var identifier = law.LawIdentifierOverride ?? $"{law.Order}";
        var lawIdentifier = Loc.GetString("laws-ui-law-header", ("id", identifier));
        var lawDescription = Loc.GetString(law.ReadLawString(readoutModeEnabled));

        LawNumberLabel.SetMarkup(lawIdentifier);
        LawLabel.SetMessage(lawDescription);

        // If you can't talk, you can't state your laws...
        if (!_entityManager.TryGetComponent<SpeechComponent>(uid, out var speech) || speech.SpeechSounds is null)
            return;

        var stateLawMessage = $"{FormattedMessage.RemoveMarkupPermissive(lawIdentifier)}: {FormattedMessage.RemoveMarkupPermissive(lawDescription)}";

        var stateLawInLocalButton = NewStateLawButton("hud-chatbox-select-channel-Local", Color.DarkGray);
        var stateLawInLocalHashCode = law.GetHashCode();

        stateLawInLocalButton.OnPressed += e => OnStateLawsButtonPressed(e.Button, stateLawMessage, string.Empty, stateLawInLocalHashCode);
        AddStateLawButton(stateLawInLocalButton, stateLawInLocalHashCode);

        if (radioChannels == null)
            return;

        foreach (var radioChannel in radioChannels)
        {
            if (!_prototypeManager.TryIndex<RadioChannelPrototype>(radioChannel, out var radioChannelProto))
                continue;

            var stateLawOnRadioButton = NewStateLawButton(radioChannelProto.Name, radioChannelProto.Color);
            var stateLawOnRadioHashCode = HashCode.Combine(law, radioChannel);

            var channelPrefix = radioChannel == SharedChatSystem.CommonChannel
                ? SharedChatSystem.RadioCommonPrefix.ToString()
                : $"{SharedChatSystem.RadioChannelPrefix}{radioChannelProto.KeyCode}";

            stateLawOnRadioButton.OnPressed += e => OnStateLawsButtonPressed(e.Button, stateLawMessage, channelPrefix, stateLawOnRadioHashCode);
            AddStateLawButton(stateLawOnRadioButton, stateLawOnRadioHashCode);
        }
    }

    protected override void FrameUpdate(FrameEventArgs args)
    {
        base.FrameUpdate(args);

        if (_stateLawOnCooldownUntil.Count == 0)
            return;

        var curTime = _timing.CurTime;

        // iterate over copy of keys because we are modifying the working set
        var toCheck = _stateLawOnCooldownUntil.Keys.ToArray();
        foreach (var stateLawHashCode in toCheck)
        {
            if (_stateLawOnCooldownUntil[stateLawHashCode] > curTime)
                continue;

            _stateLawButton[stateLawHashCode].Disabled = false;
            _stateLawOnCooldownUntil.Remove(stateLawHashCode);
        }
    }

    private void OnStateLawsButtonPressed(BaseButton sender, string message, string channelPrefix, int stateLawHashCode)
    {
        // Send message in chat
        var chatSelectChannel = string.IsNullOrEmpty(channelPrefix) ? ChatSelectChannel.Local : ChatSelectChannel.Radio;
        _chatManager.SendMessage($"{channelPrefix} {message}", chatSelectChannel);

        // Set cooldown if any
        if (PressCooldown <= TimeSpan.Zero)
            return;

        _stateLawOnCooldownUntil[stateLawHashCode] = _timing.CurTime + PressCooldown;
        sender.Disabled = true;
    }

    private static Button NewStateLawButton(string locStringCaption, Color color)
    {
        return new Button
        {
            Text = Loc.GetString(locStringCaption),
            Modulate = color,
            StyleClasses = { "chatSelectorOptionButton" },
            MinHeight = 35,
            MinWidth = 75,
        };
    }

    private void AddStateLawButton(Button button, int stateLawHashCode)
    {
        _stateLawButton[stateLawHashCode] = button;
        LawAnnouncementButtons.AddChild(button);
    }
}
