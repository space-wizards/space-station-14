using System.Linq;
using System.Numerics;
using Content.Client.Resources;
using Content.Client.Stylesheets;
using Robust.Client.AutoGenerated;
using Robust.Client.ResourceManagement;
using Robust.Client.UserInterface;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Utility;
using static Content.Client.Changelog.ChangelogManager;
using static Robust.Client.UserInterface.Controls.BoxContainer;

namespace Content.Client.Changelog;

[GenerateTypedNameReferences]
public sealed partial class ChangelogTab : Control
{
    [Dependency] private readonly ChangelogManager _changelog = default!;
    [Dependency] private readonly IResourceCache _resourceCache = default!;

    public bool AdminOnly;

    /// <summary>
    /// Changelog is from a PR marked "Experimental" and should therefore have an additional icon.
    /// </summary>
    private static string _experimentalString = "Intent: Experimental";

    public ChangelogTab()
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);
    }

    public void PopulateChangelog(ChangelogManager.Changelog changelog)
    {
        var byDay = changelog.Entries
            .GroupBy(e => e.Time.ToLocalTime().Date)
            .OrderByDescending(c => c.Key);

        var hasRead = changelog.Name != MainChangelogName ||
                      _changelog.MaxId <= _changelog.LastReadId;

        foreach (var dayEntries in byDay)
        {
            var day = dayEntries.Key;

            var groupedEntries = dayEntries
                .GroupBy(c => (c.Author, Read: c.Id <= _changelog.LastReadId))
                .OrderBy(c => c.Key.Read)
                .ThenBy(c => c.Key.Author);

            string dayNice;
            var today = DateTime.Today;
            if (day == today)
                dayNice = Loc.GetString("changelog-today");
            else if (day == today.AddDays(-1))
                dayNice = Loc.GetString("changelog-yesterday");
            else
                dayNice = day.ToShortDateString();

            ChangelogBody.AddChild(new Label
            {
                Text = dayNice,
                StyleClasses = { StyleBase.StyleClassLabelHeading },
                Margin = new Thickness(4, 6, 0, 0)
            });

            var first = true;

            foreach (var groupedEntry in groupedEntries)
            {
                var (author, read) = groupedEntry.Key;

                if (!first)
                {
                    ChangelogBody.AddChild(new Control { Margin = new Thickness(4) });
                }

                if (read && !hasRead)
                {
                    hasRead = true;

                    var upArrow =
                        _resourceCache.GetTexture("/Textures/Interface/Changelog/up_arrow.svg.192dpi.png");

                    var readDivider = new BoxContainer
                    {
                        Orientation = LayoutOrientation.Vertical
                    };

                    var hBox = new BoxContainer
                    {
                        Orientation = LayoutOrientation.Horizontal,
                        HorizontalAlignment = HAlignment.Center,
                        Children =
                        {
                            new TextureRect
                            {
                                Texture = upArrow,
                                ModulateSelfOverride = Color.FromHex("#888"),
                                TextureScale = new Vector2(0.5f, 0.5f),
                                Margin = new Thickness(4, 3),
                                VerticalAlignment = VAlignment.Bottom
                            },
                            new Label
                            {
                                Align = Label.AlignMode.Center,
                                Text = Loc.GetString("changelog-new-changes"),
                                FontColorOverride = Color.FromHex("#888"),
                            },
                            new TextureRect
                            {
                                Texture = upArrow,
                                ModulateSelfOverride = Color.FromHex("#888"),
                                TextureScale = new Vector2(0.5f, 0.5f),
                                Margin = new Thickness(4, 3),
                                VerticalAlignment = VAlignment.Bottom
                            }
                        }
                    };

                    readDivider.AddChild(hBox);
                    readDivider.AddChild(new PanelContainer { StyleClasses = { StyleBase.ClassLowDivider } });
                    ChangelogBody.AddChild(readDivider);

                    if (first)
                        readDivider.SetPositionInParent(ChangelogBody.ChildCount - 2);
                }

                first = false;

                var authorLabel = new RichTextLabel
                {
                    Margin = new Thickness(6, 0, 0, 0),
                };
                authorLabel.SetMessage(
                    FormattedMessage.FromMarkupOrThrow(Loc.GetString("changelog-author-changed", ("author", FormattedMessage.EscapeText(author)))));
                ChangelogBody.AddChild(authorLabel);

                foreach (var (labels, changes) in groupedEntry.Select(c => (c.Labels, c.Changes)))
                {
                    foreach (var change in changes)
                    {
                        var entry = new ChangelogEntry();
                        entry.SetText(FormattedMessage.FromUnformatted(change.Message));
                        entry.SetIcons(change.Type, labels.Contains(_experimentalString));
                        ChangelogBody.AddChild(entry);
                    }
                }
            }
        }
    }
}
