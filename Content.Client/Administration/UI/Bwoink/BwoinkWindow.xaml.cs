using System.Linq;
using Content.Client.Administration.Managers;
using Content.Shared.Administration.Managers.Bwoink;
using Robust.Client.AutoGenerated;
using Robust.Client.Player;
using Robust.Client.UserInterface.CustomControls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Prototypes;

namespace Content.Client.Administration.UI.Bwoink;

/// <summary>
/// This window connects to a BwoinkSystem channel. BwoinkSystem manages the rest.
/// </summary>
[GenerateTypedNameReferences]
public sealed partial class BwoinkWindow : DefaultWindow
{
    public BwoinkWindow(ClientBwoinkManager clientBwoinkManager,
        IPrototypeManager prototypeManager,
        IPlayerManager playerManager)
    {
        RobustXamlLoader.Load(this);

        var channels = prototypeManager.EnumeratePrototypes<BwoinkChannelPrototype>();
        foreach (var channel in channels.OrderBy(x => x.Order))
        {
            var canManage = clientBwoinkManager.CanManageChannel(channel, playerManager.LocalSession!);
            if (canManage)
            {
                var control = new BwoinkControl(this, channel, clientBwoinkManager);
                Channels.AddChild(control);
            }
            else
            {
                var control = new BwoinkPanel(this, channel, clientBwoinkManager);
                clientBwoinkManager.MessageReceived += (sender, args) =>
                {
                    if (sender.Id != channel.ID)
                        return;

                    control.ReceiveLine(args.message);
                };

                // Needed since the bwoinkpanel expects itself to be nested within a "proper" container.
                control.Margin = new Thickness(0.3f);

                if (clientBwoinkManager.Conversations[channel].TryGetValue(playerManager.LocalSession!.UserId, out var existingConvo))
                {
                    control.UpdateAllLines(existingConvo.Messages);
                }

                control.MessageSent += text => clientBwoinkManager.SendMessageNonAdmin(channel, text);
                Channels.AddChild(control);
            }
        }
    }
}
