using System.Linq;
using Content.Client.Administration.Managers;
using Content.Shared.Administration.Managers.Bwoink;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Network;
using Robust.Shared.Timing;
using Robust.Shared.Utility;

namespace Content.Client.Administration.UI.Bwoink;

[GenerateTypedNameReferences]
public sealed partial class BwoinkPanel : BoxContainer
{
    private List<string> PeopleTyping { get; set; } = [];
    public event Action<string>? MessageSent;
    private readonly BwoinkChannelPrototype _channel;
    private readonly bool _manager;
    private readonly ClientBwoinkManager _bwoinkManager;
    private readonly NetUserId? _managingFor;

    public BwoinkPanel(BwoinkWindow parentWindow, BwoinkChannelPrototype channel, ClientBwoinkManager clientBwoinkManager, bool manager, NetUserId? managingFor)
    {
        RobustXamlLoader.Load(this);
        // TODO: dont use static Loc for this.
        Name = Loc.GetString(channel.Name);

        _channel = channel;
        _manager = manager;
        _bwoinkManager = clientBwoinkManager;
        _managingFor = managingFor;

        if (!manager)
        {
            var helpText = new FormattedMessage(1);
            helpText.AddMarkupOrThrow(Loc.GetString(channel.HelpText));
            TextOutput.AddMessage(helpText);
        }

        if (!_bwoinkManager.CanWriteChannel(channel))
        {
            ReadOnlyLabel.Visible = true;
            SenderLineEdit.Visible = false;
        }

        var msg = new FormattedMessage();
        msg.PushColor(Color.LightGray);
        msg.AddText(Loc.GetString("bwoink-system-messages-being-relayed-to-discord"));
        msg.Pop();
        RelayedToDiscordLabel.SetMessage(msg);

        OnVisibilityChanged += c =>
        {
            if (c.Visible && _managingFor.HasValue)
                _bwoinkManager.GetOrCreatePlayerPropertiesForChannel(_channel.ID, _managingFor.Value).Unread = 0;
        };
        SenderLineEdit.OnTextEntered += Input_OnTextEntered;
        SenderLineEdit.OnTextChanged += Input_OnTextChanged;

        UpdateTypingIndicator();
    }

    protected override void EnteredTree()
    {
        _bwoinkManager.TypingsUpdated += BwoinkManagerOnTypingsUpdated;
    }

    protected override void ExitedTree()
    {
        _bwoinkManager.TypingsUpdated -= BwoinkManagerOnTypingsUpdated;
    }

    private void BwoinkManagerOnTypingsUpdated()
    {
        if (!_managingFor.HasValue)
            return;

        PeopleTyping = _bwoinkManager.GetTypingStatuses(_channel.ID, _managingFor.Value)
            .Select(x => x.Username)
            .ToList();

        UpdateTypingIndicator();
    }


    private void Input_OnTextEntered(LineEdit.LineEditEventArgs args)
    {
        if (string.IsNullOrWhiteSpace(args.Text))
            return;

        MessageSent?.Invoke(args.Text);
        _bwoinkManager.SetTypingStatus(_channel.ID, false, _managingFor);
        SenderLineEdit.Clear();
    }

    private void Input_OnTextChanged(LineEdit.LineEditEventArgs args)
    {
        var isEditing = !string.IsNullOrWhiteSpace(args.Text);

        _bwoinkManager.SetTypingStatus(_channel.ID, isEditing, _managingFor);
        UpdateTypingIndicator();
    }

    public void UpdateAllLines(List<BwoinkMessage> messages)
    {
        TextOutput.Clear();

        if (!_manager)
        {
            // TODO: dont use static Loc for this.
            var helpText = new FormattedMessage(1);
            helpText.AddMarkupOrThrow(Loc.GetString(_channel.HelpText));
            TextOutput.AddMessage(helpText);
        }

        foreach (var message in messages)
        {
            TextOutput.AddMessage(FormatMessage(message));
            if (_managingFor.HasValue)
            {
                _bwoinkManager.GetOrCreatePlayerPropertiesForChannel(_channel.ID, _managingFor.Value).LastMessage = message.SentAt;
            }
        }
    }

    public void ReceiveLine(BwoinkMessage message)
    {
        if (_managingFor.HasValue)
        {
            var info = _bwoinkManager.GetOrCreatePlayerPropertiesForChannel(_channel.ID, _managingFor.Value);
            info.LastMessage = message.SentAt;
            if (!Visible)
                info.Unread++;
        }

        TextOutput.AddMessage(FormatMessage(message));
    }

    private FormattedMessage FormatMessage(BwoinkMessage message)
    {
        var formatted = new FormattedMessage();

        var color = Color.White;
        if (message.Flags.HasFlag(MessageFlags.Manager))
            color = Color.Red;

        formatted.PushColor(Color.Gray);
        formatted.AddText($"{message.SentAt.ToShortTimeString()} ");
        formatted.Pop();

        formatted.PushColor(color);
        formatted.AddText($"{message.Sender} ");
        formatted.Pop();

        formatted.AddText(message.Content);

        return formatted;
    }

    private void UpdateTypingIndicator()
    {
        var msg = new FormattedMessage();
        msg.PushColor(Color.LightGray);

        var text = PeopleTyping.Count == 0
            ? string.Empty
            : Loc.GetString("bwoink-system-typing-indicator",
                ("players", string.Join(", ", PeopleTyping)),
                ("count", PeopleTyping.Count));

        msg.AddText(text);
        msg.Pop();

        TypingIndicator.SetMessage(msg);
    }
}
