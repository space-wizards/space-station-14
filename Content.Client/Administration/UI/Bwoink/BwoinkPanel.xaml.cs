using System.Linq;
using Content.Client.Administration.Managers;
using Content.Shared.Administration.Managers.Bwoink;
using Content.Shared.Administration.Managers.Bwoink.Features;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Network;
using Robust.Shared.Utility;

namespace Content.Client.Administration.UI.Bwoink;

[GenerateTypedNameReferences]
public sealed partial class BwoinkPanel : BoxContainer
{
    private List<string> PeopleTyping { get; set; } = [];
    public event Action<(string text, MessageFlags flags)>? MessageSent;
    private readonly BwoinkChannelPrototype _channel;
    private readonly bool _manager;
    private readonly ClientBwoinkManager _bwoinkManager;
    private readonly ILocalizationManager _localizationManager;
    private readonly NetUserId? _managingFor;

    public BwoinkPanel(BwoinkWindow parentWindow, BwoinkChannelPrototype channel, ClientBwoinkManager clientBwoinkManager, bool manager, NetUserId? managingFor, ILocalizationManager localizationManager)
    {
        RobustXamlLoader.Load(this);
        _localizationManager = localizationManager;

        Name = _localizationManager.GetString(channel.Name);

        _channel = channel;
        _manager = manager;
        _bwoinkManager = clientBwoinkManager;
        _managingFor = managingFor;

        if (!manager)
        {
            var helpText = new FormattedMessage(1);
            helpText.AddMarkupOrThrow(_localizationManager.GetString(channel.HelpText));
            TextOutput.AddMessage(helpText);
            HandledLabel.Visible = true;
        }

        if (!_bwoinkManager.CanWriteChannel(channel))
        {
            ReadOnlyLabel.Visible = true;
            SenderLineEdit.Visible = false;
        }

        OnVisibilityChanged += c =>
        {
            if (!c.Visible)
                return;

            if (_managingFor.HasValue)
                _bwoinkManager.GetOrCreatePlayerPropertiesForChannel(_channel.ID, _managingFor.Value).Unread = 0;

            if (!_manager)
                parentWindow.Title = _localizationManager.GetString(channel.Name);
        };
        SenderLineEdit.OnTextEntered += Input_OnTextEntered;
        SenderLineEdit.OnTextChanged += Input_OnTextChanged;

        UpdateTypingIndicator();
    }

    protected override void EnteredTree()
    {
        _bwoinkManager.TypingsUpdated += BwoinkManagerOnTypingsUpdated;

        MessagePropsContainer.Visible = _manager;

        if (_channel.Features.TryFirstOrDefault(x => x is ManagerOnlyMessages, out var channelFeature))
        {
            var managerOnly = channelFeature as ManagerOnlyMessages;
            ManagerOnly.ToolTip = _localizationManager.GetString(managerOnly!.ToolTip);
            ManagerOnly.Text = _localizationManager.GetString(managerOnly.CheckName);
        }
        else
            ManagerOnly.Visible = false;

        Silent.Visible = _channel.TryGetFeature<SoundOnMessage>(out var soundOnMessage) && soundOnMessage.AllowSilent;
    }

    protected override void ExitedTree()
    {
        _bwoinkManager.TypingsUpdated -= BwoinkManagerOnTypingsUpdated;
    }

    private void BwoinkManagerOnTypingsUpdated()
    {
        if (!_managingFor.HasValue)
            return;

        PeopleTyping = _bwoinkManager.GetTypingStatuses(_channel.ID, _managingFor.Value)
            .Select(x => x.Username)
            .ToList();

        UpdateTypingIndicator();
    }


    private void Input_OnTextEntered(LineEdit.LineEditEventArgs args)
    {
        if (string.IsNullOrWhiteSpace(args.Text))
            return;

        var flags = MessageFlags.None;

        if (ManagerOnly.Pressed)
            flags |= MessageFlags.ManagerOnly;

        if (!Silent.Pressed)
            flags |= MessageFlags.Silent;

        MessageSent?.Invoke((args.Text, flags));
        _bwoinkManager.SetTypingStatus(_channel.ID, false, _managingFor);
        SenderLineEdit.Clear();
    }

    private void Input_OnTextChanged(LineEdit.LineEditEventArgs args)
    {
        var isEditing = !string.IsNullOrWhiteSpace(args.Text);

        _bwoinkManager.SetTypingStatus(_channel.ID, isEditing, _managingFor);
        UpdateTypingIndicator();
    }

    public void UpdateAllLines(List<BwoinkMessage> messages)
    {
        TextOutput.Clear();

        if (!_manager)
        {
            var helpText = new FormattedMessage(1);
            helpText.AddMarkupOrThrow(_localizationManager.GetString(_channel.HelpText));
            TextOutput.AddMessage(helpText);
        }

        foreach (var message in messages)
        {
            TextOutput.AddMessage(_bwoinkManager.FormatMessage(_channel, message));
            if (_managingFor.HasValue)
            {
                _bwoinkManager.GetOrCreatePlayerPropertiesForChannel(_channel.ID, _managingFor.Value).LastMessage = message.SentAt;
            }
        }
    }

    public void ReceiveLine(BwoinkMessage message)
    {
        if (_managingFor.HasValue)
        {
            var info = _bwoinkManager.GetOrCreatePlayerPropertiesForChannel(_channel.ID, _managingFor.Value);
            info.LastMessage = message.SentAt;
            if (!VisibleInTree)
                info.Unread++;
        }

        TextOutput.AddMessage(_bwoinkManager.FormatMessage(_channel, message));
    }

    private void UpdateTypingIndicator()
    {
        var msg = new FormattedMessage();
        msg.PushColor(Color.LightGray);

        var text = PeopleTyping.Count == 0
            ? string.Empty
            : _localizationManager.GetString("bwoink-system-typing-indicator",
                ("players", string.Join(", ", PeopleTyping)),
                ("count", PeopleTyping.Count));

        msg.AddText(text);
        msg.Pop();

        TypingIndicator.SetMessage(msg);
    }
}
