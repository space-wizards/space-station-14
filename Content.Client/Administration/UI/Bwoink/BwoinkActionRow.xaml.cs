using Content.Client.Administration.Managers;
using Content.Client.UserInterface.Controls;
using Content.Shared.Administration;
using Content.Shared.Administration.Managers.Bwoink;
using Content.Shared.Administration.Managers.Bwoink.Features;
using Robust.Client.AutoGenerated;
using Robust.Client.Console;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Player;
using Robust.Shared.Prototypes;

namespace Content.Client.Administration.UI.Bwoink;

[GenerateTypedNameReferences]
public sealed partial class BwoinkActionRow : BoxContainer
{
    private readonly ActionRow _row;
    private readonly IClientAdminManager _clientAdminManager;
    private readonly ILocalizationManager _localizationManager;
    private readonly IClientConsoleHost _clientConsoleHost;
    private readonly ClientBwoinkManager _clientBwoinkManager;
    private readonly ProtoId<BwoinkChannelPrototype> _id;

    public PlayerInfo? PlayerInfo
    {
        get => _playerInfo;
        set
        {
            _playerInfo = value;
            Generate();
        }
    }

    private PlayerInfo? _playerInfo;
    private readonly ICommonSession _self;

    public BwoinkActionRow(ActionRow row,
        IClientAdminManager adminManager,
        ILocalizationManager localizationManager,
        IClientConsoleHost clientConsoleHost,
        ICommonSession self,
        ClientBwoinkManager clientBwoinkManager,
        ProtoId<BwoinkChannelPrototype> id)
    {
        RobustXamlLoader.Load(this);

        _row = row;
        _clientAdminManager = adminManager;
        _localizationManager = localizationManager;
        _clientConsoleHost = clientConsoleHost;
        _self = self;
        _clientBwoinkManager = clientBwoinkManager;
        _id = id;

        Generate();
    }

    protected override void EnteredTree()
    {
        base.EnteredTree();
        _clientAdminManager.AdminStatusUpdated += Generate;
    }

    protected override void ExitedTree()
    {
        base.ExitedTree();
        _clientAdminManager.AdminStatusUpdated -= Generate;
    }

    private void Generate()
    {
        RemoveAllChildren();
        // kill the children
        var rowTouse = _row;
        if (_clientBwoinkManager.CustomChannelActionRows.TryGetValue(_id, out var custom))
        {
            rowTouse = custom;
        }
        for (var index = 0; index < rowTouse.Buttons.Count; index++)
        {
            var actionButton = rowTouse.Buttons[index];
            Button button;
            /*
             * OK SO BEFORE I GET PIPEBOMBS SENT TO MY HOUSE
             * Just having one codepath with a common button doesn't work
             * Why? Well ConfirmButton hides the OnPressed and Text props with its own version using the 'new' keyword.
             * Simply being funny and using a common button class makes it use the Button versions instead of the ConfirmButton versions.
             * This code sucks but I cant think of a better way to do it rn.
             */
            switch (actionButton.Confirm)
            {
                case true:
                    var tempConfirm = new ConfirmButton();
                    tempConfirm.OnPressed += _ =>
                    {
                        OnButtonPressed(actionButton);
                    };

                    tempConfirm.Text = _localizationManager.GetString(actionButton.Label);
                    button = tempConfirm;
                    break;

                case false:
                    button = new Button(); // button is equal to button, true

                    button.OnPressed += _ =>
                    {
                        OnButtonPressed(actionButton);
                    };

                    button.Text = _localizationManager.GetString(actionButton.Label);
                    break;
            }

            if (rowTouse.Buttons.Count != 1)
            {
                if (index == 0)
                    button.StyleClasses.Add("OpenRight");
                else if (index == rowTouse.Buttons.Count - 1)
                    button.StyleClasses.Add("OpenLeft");
                else
                    button.StyleClasses.Add("OpenBoth");
            }

            button.Disabled = !_clientAdminManager.HasFlag(actionButton.Flags);
            if (PlayerInfo == null && !actionButton.AlwaysAvailable)
            {
                button.Disabled = true;
            }

            AddChild(button);
        }
    }

    private void OnButtonPressed(ActionButton button)
    {
        switch (button.AlwaysAvailable)
        {
            case true:
                _clientConsoleHost.ExecuteCommand(button.Command
                    .Replace("$SelfID", _self.UserId.ToString())
                    .Replace("$SelfName", _self.Name));
                break;
            case false:
                if (_playerInfo == null)
                    throw new InvalidOperationException("No player selected!");

                _clientConsoleHost.ExecuteCommand(button.Command
                    .Replace("$SelfID", _self.UserId.ToString())
                    .Replace("$SelfName", _self.Name)
                    .Replace("$ID", _playerInfo.SessionId.ToString())
                    .Replace("$Name", _playerInfo.Username)
                    .Replace("$NetEnt", _playerInfo.NetEntity.ToString()));
                break;
        }
    }
}
