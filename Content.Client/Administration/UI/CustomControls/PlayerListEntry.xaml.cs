using Content.Client.Stylesheets;
using Content.Shared.Administration;
using Content.Shared.Roles;
using Content.Shared.StatusIcon;
using Robust.Client.AutoGenerated;
using Robust.Client.GameObjects;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Prototypes;
using Robust.Shared.Utility;

namespace Content.Client.Administration.UI.CustomControls;

[GenerateTypedNameReferences]
public sealed partial class PlayerListEntry : BoxContainer
{
    [Dependency] private readonly IEntitySystemManager _entity = default!;
    [Dependency] private readonly IPrototypeManager _proto = default!;

    private readonly ResPath _pinnedResPath = new("/Textures/Interface/Bwoink/pinned.png");
    private readonly ResPath _unPinnedResPath = new("/Textures/Interface/Bwoink/un_pinned.png");

    private readonly ProtoId<JobIconPrototype> _unknownJobIcon = "JobIconUnknown";

    private readonly SpriteSystem _sprite;

    public PlayerListEntry()
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);

        _sprite = _entity.GetEntitySystem<SpriteSystem>();
    }

    public event Action<PlayerInfo>? OnPinStatusChanged;

    public void Setup(PlayerInfo info, Func<PlayerInfo, string, string>? overrideText)
    {
        Update(info, overrideText);
        PlayerEntryPinButton.OnPressed += HandlePinButtonPressed(info);
    }

    private Action<BaseButton.ButtonEventArgs> HandlePinButtonPressed(PlayerInfo info)
    {
        return args =>
        {
            info.IsPinned = !info.IsPinned;
            UpdatePinButtonTexture(info.IsPinned);
            OnPinStatusChanged?.Invoke(info);
        };
    }

    private void Update(PlayerInfo info, Func<PlayerInfo, string, string>? overrideText)
    {
        PlayerEntryLabel.Text = overrideText?.Invoke(info, $"{info.CharacterName} ({info.Username})") ??
                                $"{info.CharacterName} ({info.Username})";

        UpdatePinButtonTexture(info.IsPinned);
        UpdateJobIcon(info.StartingJob);
    }

    private void UpdatePinButtonTexture(bool isPinned)
    {
        PlayerEntryPinButton.TexturePath = isPinned ? _pinnedResPath.CanonPath : _unPinnedResPath.CanonPath;
    }

    private void UpdateJobIcon(ProtoId<JobPrototype>? job)
    {
        if (_proto.TryIndex(job, out var jobProto) && _proto.TryIndex(jobProto.Icon, out var jobIconProto))
            PlayerJobIcon.Texture = _sprite.Frame0(jobIconProto.Icon);
        else
            PlayerJobIcon.Texture = _sprite.Frame0(_proto.Index(_unknownJobIcon).Icon);
    }
}
