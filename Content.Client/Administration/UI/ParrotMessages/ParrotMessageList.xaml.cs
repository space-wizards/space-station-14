using Content.Shared.Administration.ParrotMessages;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;

namespace Content.Client.Administration.UI.ParrotMessages;

[GenerateTypedNameReferences]
public sealed partial class ParrotMessageList : BoxContainer
{
    public bool ShowBlocked { get; set; }
    public bool Initialized { get; private set; }
    public bool Dirty { get; set; }

    private int _messageCount;

    public ParrotMessageList() : base()
    {
        RobustXamlLoader.Load(this);
        Dirty = true;
    }

    private void UpdateMessageCountText(int messageCount)
    {
        _messageCount = messageCount;
        MessageCountLabel.Text = Loc.GetString("parrot-messages-num-messages", ("messageCount", _messageCount));
    }

    private ParrotMessageLine AddMessageLine(ExtendedPlayerMessage memory, int roundId)
    {
        var messageLine = new ParrotMessageLine();

        messageLine.SetMessage(memory, roundId);

        MessageContainer.AddChild(messageLine);

        return messageLine;
    }

    public void UpdateMessages(ParrotMessagesEui eui, ParrotMessagesEuiState messageState)
    {
        Initialized = true;

        UpdateMessageCountText(messageState.Messages.Count);

        MessageContainer.RemoveAllChildren();

        foreach (var message in messageState.Messages)
        {
            var messageLine = AddMessageLine(message, messageState.RoundId);

            messageLine.ParrotBlockButton.OnPressed += (_) =>
            {
                eui.ChangeMessageBlock(message.MessageId, !message.Blocked);
                MessageContainer.RemoveChild(messageLine);
                UpdateMessageCountText(_messageCount - 1);
            };

            // default text and tooltip refer to unblocked messages
            if (!message.Blocked)
                continue;

            messageLine.ParrotBlockButton.Text = Loc.GetString("parrot-messages-line-unblock");
            messageLine.ParrotBlockButton.ToolTip = Loc.GetString("parrot-messages-line-unblock-tooltip");
        }
    }
}
