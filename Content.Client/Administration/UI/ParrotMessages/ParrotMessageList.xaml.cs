using Content.Shared.Administration.ParrotMessages;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.Controls;

namespace Content.Client.Administration.UI.ParrotMessages;

[GenerateTypedNameReferences]
public sealed partial class ParrotMessageList : BoxContainer
{
    public bool ShowBlocked { get; set; }
    public bool Initialized { get; private set; }

    private void UpdateMessageCountText(int messageCount)
    {
        ParrotMessageCountLabel.Text = Loc.GetString("parrot-messages-num-messages", ("messageCount", messageCount));
    }

    private ParrotMessageLine AddMessageLine(ExtendedPlayerMessage memory)
    {
        var messageLine = new ParrotMessageLine();

        messageLine.SetMessage(memory);

        ParrotMessageContainer.AddChild(messageLine);

        return messageLine;
    }

    public void UpdateMessages(ParrotMessagesEui eui, List<ExtendedPlayerMessage> parrotMemories)
    {
        Initialized = true;

        UpdateMessageCountText(parrotMemories.Count);

        ParrotMessageContainer.RemoveAllChildren();

        foreach (var memory in parrotMemories)
        {
            var messageLine = AddMessageLine(memory);

            messageLine.ParrotBlockButton.OnPressed += (_) =>
            {
                eui.ChangeMessageBlock(memory.MessageId, !memory.Blocked);
                ParrotMessageContainer.RemoveChild(messageLine);
            };

            // default text and tooltip refer to unblocked messages
            if (!memory.Blocked)
                continue;

            messageLine.ParrotBlockButton.Text = Loc.GetString("parrot-messages-line-unblock");
            messageLine.ParrotBlockButton.ToolTip = Loc.GetString("parrot-messages-line-unblock-tooltip");
        }
    }
}
