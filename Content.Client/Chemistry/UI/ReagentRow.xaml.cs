using System.Linq;
using Content.Client.Stylesheets;
using Content.Shared.Chemistry.Components;
using Content.Shared.Chemistry.Reagent;
using Content.Shared.FixedPoint;
using Robust.Client.AutoGenerated;
using Robust.Client.Graphics;
using Robust.Client.UserInterface;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Prototypes;

namespace Content.Client.Chemistry.UI;

[GenerateTypedNameReferences]
public sealed partial class ReagentRow : Control
{
    public event Action<FixedPoint2>? OnAmountPressed;

    public ReagentRow(string name,
        FixedPoint2 quantity,
        List<FixedPoint2> buttonAmounts,
        Color? colorTab,
        Color rowColor)
    {
        RobustXamlLoader.Load(this);

        SetQuantity(quantity);
        ReagentName.Text = $"{name}: ";
        SetRowColor(rowColor);

        if (colorTab is { } color)
            ReagentColor.PanelOverride = new StyleBoxFlat(color);

        if (buttonAmounts.Count == 0)
            return;

        // Make sure we mark the last button as the "rightmost" one
        foreach (var amount in buttonAmounts[..^1])
        {
            InnerContainer.AddChild(MakeButton(amount, false));
        }

        // We have at least one button so this is safe
        InnerContainer.AddChild(MakeButton(buttonAmounts[^1], true));
    }

    private Button MakeButton(FixedPoint2 amount, bool rightmost)
    {
        var text = amount == FixedPoint2.MaxValue
            ? Loc.GetString("chem-master-window-buffer-all-amount")
            : amount.ToString();

        var style = rightmost ? StyleBase.ButtonOpenLeft : StyleBase.ButtonOpenBoth;

        var button = new Button
        {
            Text = text,
            StyleClasses = { style },
        };

        button.OnPressed += _ => OnAmountPressed?.Invoke(amount);

        return button;
    }

    public void SetQuantity(FixedPoint2 quantity)
    {
        ReagentQuantityLabel.Text = ReagentQuantity.LocalizedQuantity(quantity);
    }

    public void SetRowColor(Color color)
    {
        Row.PanelOverride = new StyleBoxFlat(color);
    }
}
