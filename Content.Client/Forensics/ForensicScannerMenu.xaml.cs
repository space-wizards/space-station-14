using System.Text;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.CustomControls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Timing;
using Content.Shared.Forensics.Components;

namespace Content.Client.Forensics
{
    [GenerateTypedNameReferences]
    public sealed partial class ForensicScannerMenu : DefaultWindow
    {
        [Dependency] private readonly IEntityManager _entity = default!;
        [Dependency] private readonly IGameTiming _gameTiming = default!;

        public ForensicScannerMenu()
        {
            RobustXamlLoader.Load(this);
            IoCManager.InjectDependencies(this);
        }

        public void UpdatePrinterState(bool disabled)
        {
            Print.Disabled = disabled;
        }

        public void Update(EntityUid uid)
        {
            var forensicComp = _entity.GetComponent<ForensicScannerComponent>(uid);

            if (string.IsNullOrEmpty(forensicComp.LastScannedName))
            {
                Print.Disabled = true;
                Clear.Disabled = true;
                NameLabel.Text = string.Empty;
                Diagnostics.Text = string.Empty;
                return;
            }

            Print.Disabled = (forensicComp.PrintReadyAt > _gameTiming.CurTime);
            Clear.Disabled = false;

            NameLabel.Text = forensicComp.LastScannedName;

            var text = new StringBuilder();

            text.AppendLine(Loc.GetString("forensic-scanner-interface-fingerprints"));
            foreach (var fingerprint in forensicComp.Fingerprints)
            {
                text.AppendLine(fingerprint);
            }
            text.AppendLine();
            text.AppendLine(Loc.GetString("forensic-scanner-interface-fibers"));
            foreach (var fiber in forensicComp.Fibers)
            {
                text.AppendLine(fiber);
            }
            text.AppendLine();
            text.AppendLine(Loc.GetString("forensic-scanner-interface-dnas"));
            foreach (var dna in forensicComp.DNAs)
            {
                text.AppendLine(dna);
            }
            foreach (var dna in forensicComp.SolutionDNAs)
            {
                if (forensicComp.DNAs.Contains(dna))
                    continue;
                text.AppendLine(dna);
            }
            text.AppendLine();
            text.AppendLine(Loc.GetString("forensic-scanner-interface-residues"));
            foreach (var residue in forensicComp.Residues)
            {
                text.AppendLine(residue);
            }
            Diagnostics.Text = text.ToString();
        }
    }
}
