using Content.Client.UserInterface.Controls;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Timing;

namespace Content.Client.Instruments.UI
{
    [GenerateTypedNameReferences]
    public sealed partial class InstrumentMenu : FancyWindow
    {
        public EntityUid Entity;

        public event Action<EntityUid>? SetBandMasterRequest;
        public event Action? RefreshBandsRequest;

        private InstrumentMidiSourceBase? _currentMode;

        public InstrumentMenu()
        {
            RobustXamlLoader.Load(this);

            ConfigurationCollapsibleHeading.AddStyleClass(ContainerButton.StyleClassButton);
            ConfigurationCollapsibleHeading.Label.Text = "Configuration";

            BandControl.JoinBandRequest += BandControl_JoinBandRequest;
            BandControl.RefreshBandRequest += BandControl_RefreshBandRequest;

            SetupSources(FileControl, BandControl, InputControl);
            SwitchMode(FileControl);
        }

        protected override void ExitedTree()
        {
            base.ExitedTree();

            if (_currentMode != null)
            {
                _currentMode.ClearInstrument();
            }
        }

        private void SetupSources(params InstrumentMidiSourceBase[] modes)
        {
            ButtonGroup group = new ButtonGroup();
            Button? firstButton = null;
            foreach (var mode in modes)
            {
                var button = new Button();
                if (firstButton == null)
                    firstButton = button;
                button.Text = mode.ButtonName;
                button.Group = group;
                button.OnPressed += (o) => { SwitchMode(mode); };
                MidiSourceButtonsBoxContainer.Children.Add(button);
            }
            firstButton!.Pressed = true;
        }

        private void SwitchMode(InstrumentMidiSourceBase mode)
        {
            if (_currentMode != null)
            {
                _currentMode.Visible = false;
                _currentMode.ClearInstrument();
            }
            _currentMode = mode;
            _currentMode.SetInstrument(Entity);
            _currentMode.Visible = true;
        }

        private void BandControl_RefreshBandRequest()
        {
            RefreshBandsRequest?.Invoke();
        }

        private void BandControl_JoinBandRequest(EntityUid ent)
        {
            SetBandMasterRequest?.Invoke(ent);
        }

        public void SetInstrument(Entity<InstrumentComponent> entity)
        {
            Entity = entity;
            var component = entity.Comp;
            InstrumentSpriteView.SetEntity(entity);
            if (_currentMode != null)
            {
                _currentMode.SetInstrument(entity);
            }
        }

        public void NotifyTrackEnded()
        {
            if (FileControl.Visible)
                FileControl.PlayNextTrack();
        }

        public void SetMIDIAvailability(bool available)
        {
            UnavailableOverlay.Visible = !available;
        }

        public void PopulateBands((NetEntity, string)[] nearby, IEntityManager entManager)
        {
            if (BandControl.Visible)
                BandControl.Populate(nearby, entManager);
        }
    }
}
