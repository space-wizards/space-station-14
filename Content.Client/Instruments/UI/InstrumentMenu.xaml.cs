using Content.Client.UserInterface.Controls;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;

namespace Content.Client.Instruments.UI
{
    [GenerateTypedNameReferences]
    public sealed partial class InstrumentMenu : FancyWindow
    {
        private InstrumentMidiSourceBase? _currentMode;

        public InstrumentMenu()
        {
            RobustXamlLoader.Load(this);

            ConfigurationCollapsibleHeading.AddStyleClass(ContainerButton.StyleClassButton);
            ConfigurationCollapsibleHeading.Label.Text = Loc.GetString("instruments-component-menu-configuration-collapsible-header");
        }

        protected override void ExitedTree()
        {
            base.ExitedTree();

            if (_currentMode != null)
            {
                _currentMode.Visible = false;
            }
        }

        public void SetupSources(params InstrumentMidiSourceBase[] modes)
        {
            var group = new ButtonGroup();
            for (var i = 0; i < modes.Length; i++)
            {
                var mode = modes[i];
                var button = new Button();
                button.Text = mode.ButtonName;
                button.Group = group;
                button.OnPressed += (o) => { SwitchMode(mode); };
                MidiSourceButtonsBoxContainer.Children.Add(button);
                MidiSourcesContainer.Children.Add(mode);
                mode.VerticalExpand = true;
                mode.HorizontalExpand = true;
                mode.Visible = false;

                // Set nicer style classes depending on button position.
                if (i == 0)
                {
                    button.Pressed = true;
                    button.StyleClasses.Add("OpenLeft");
                }
                else if (i == modes.Length - 1)
                {
                    button.StyleClasses.Add("OpenRight");
                }
                else
                {
                    button.StyleClasses.Add("OpenBoth");
                }
            }
        }

        public void SwitchMode(InstrumentMidiSourceBase mode)
        {
            if (_currentMode != null)
            {
                _currentMode.Visible = false;
            }
            _currentMode = mode;
            _currentMode.Visible = true;
        }

        public void SetMidiAvailability(bool available)
        {
            UnavailableOverlay.Visible = !available;
        }

        public void SetInstrument(Entity<InstrumentComponent> entity)
        {
            InstrumentSpriteView.SetEntity(entity);
        }
    }
}
