using Content.Client.UserInterface.Controls;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;

namespace Content.Client.Instruments.UI
{
    [GenerateTypedNameReferences]
    public sealed partial class InstrumentMenu : FancyWindow
    {
        private InstrumentMidiSourceBase? _currentMode;
        public EntityUid Entity;

        public event Action<EntityUid>? SetBandMasterRequest;
        public event Action? RefreshBandsRequest;

        public InstrumentMenu()
        {
            RobustXamlLoader.Load(this);

            ConfigurationCollapsibleHeading.AddStyleClass(ContainerButton.StyleClassButton);
            ConfigurationCollapsibleHeading.Label.Text = Loc.GetString("instruments-component-menu-configuration-collapsible-header");
            BandControl.JoinBandRequest += OnBandControlJoinBandRequest;
            BandControl.RefreshBandRequest += OnBandControlRefreshBandRequest;

            SetupSources(FileControl, BandControl, InputControl);
            SwitchMode(FileControl);
        }

        protected override void ExitedTree()
        {
            base.ExitedTree();

            if (_currentMode != null)
            {
                _currentMode.Visible = false;
            }
        }

        private void OnBandControlRefreshBandRequest()
        {
            RefreshBandsRequest?.Invoke();
        }

        private void OnBandControlJoinBandRequest(EntityUid ent)
        {
            SetBandMasterRequest?.Invoke(ent);
        }

        private void SetupSources(params InstrumentMidiSourceBase[] modes)
        {
            var group = new ButtonGroup();
            for (var i = 0; i < modes.Length; i++)
            {
                var mode = modes[i];
                var button = new Button();
                button.Text = mode.ButtonName;
                button.Group = group;
                button.OnPressed += (o) => { SwitchMode(mode); };
                MidiSourceButtonsBoxContainer.Children.Add(button);

                // Set nicer style classes depending on button position.
                if (i == 0)
                {
                    button.Pressed = true;
                    button.StyleClasses.Add("OpenLeft");
                }
                else if (i == modes.Length - 1)
                {
                    button.StyleClasses.Add("OpenRight");
                }
                else
                {
                    button.StyleClasses.Add("OpenBoth");
                }
            }
        }

        private void SwitchMode(InstrumentMidiSourceBase mode)
        {
            if (_currentMode != null)
            {
                _currentMode.Visible = false;
            }
            _currentMode = mode;
            _currentMode.Entity = Entity;
            _currentMode.Visible = true;
        }

        public void SetMIDIAvailability(bool available)
        {
            UnavailableOverlay.Visible = !available;
        }

        public void SetInstrument(Entity<InstrumentComponent> entity)
        {
            Entity = entity;
            var component = entity.Comp;
            InstrumentSpriteView.SetEntity(entity);
            if (_currentMode != null)
            {
                _currentMode.Entity = Entity;
            }
        }

        public void NotifyTrackEnded()
        {
            if (FileControl.Visible)
                FileControl.PlayNextTrack();
        }

        public void PopulateBands((NetEntity, string)[] nearby, IEntityManager entManager)
        {
            if (BandControl.Visible)
                BandControl.Populate(nearby, entManager);
        }
    }
}
