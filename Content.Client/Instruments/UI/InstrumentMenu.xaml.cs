using Content.Client.UserInterface.Controls;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;

namespace Content.Client.Instruments.UI
{
    [GenerateTypedNameReferences]
    public sealed partial class InstrumentMenu : FancyWindow
    {
        private InstrumentMidiSourceBase? _currentMode;

        public InstrumentMenu()
        {
            RobustXamlLoader.Load(this);

            ConfigurationCollapsibleHeading.AddStyleClass(ContainerButton.StyleClassButton);
            ConfigurationCollapsibleHeading.Label.Text = Loc.GetString("instruments-component-menu-configuration-collapsible-header");
            ConfigurationCollapsibleHeading.StyleClasses.Add("OpenRight");
            ConfigurationCollapsibleBody.OnVisibilityChanged += OnConfigurationContainerBodyVisibilityChanged;
        }

        protected override void ExitedTree()
        {
            base.ExitedTree();
            _currentMode?.Disable();
        }

        private void OnConfigurationContainerBodyVisibilityChanged(Control obj)
        {
            // Setting VerticalExpand in XAML appears to reserve a lot of space even with the body closed, thus
            // changing it here. If there is a better way, I couldn't find it.
            ConfigurationCollapsible.VerticalExpand = obj.Visible;
            InstrumentContainer.Visible = !obj.Visible;
        }

        private void OnConfigurationVisibilityChanged(Control obj)
        {
            // Same issue as with the main config container.
            if (obj is Collapsible c)
            {
                c.Body?.VerticalExpand = obj.Visible;
            }
        }

        public void SetupSources(params InstrumentMidiSourceBase[] modes)
        {
            var group = new ButtonGroup();
            for (var i = 0; i < modes.Length; i++)
            {
                var mode = modes[i];
                var button = new Button();
                button.Text = mode.ButtonName;
                button.Group = group;
                button.OnPressed += _ => { SwitchMode(mode); };
                MidiSourceButtonsBoxContainer.Children.Add(button);
                MidiSourcesContainer.Children.Add(mode);
                mode.VerticalExpand = true;
                mode.HorizontalExpand = true;
                mode.Visible = false;

                // Set nicer style classes depending on button position.
                if (i == 0)
                {
                    button.Pressed = true;
                    button.StyleClasses.Add("OpenLeft");
                }
                else if (i == modes.Length - 1)
                {
                    button.StyleClasses.Add("OpenRight");
                }
                else
                {
                    button.StyleClasses.Add("OpenBoth");
                }
            }
        }

        public void AddConfigurationControl(string name, Control ctrl)
        {
            var collapsibleBody = new CollapsibleBody();
            collapsibleBody.AddChild(ctrl);
            collapsibleBody.VerticalExpand = true;
            collapsibleBody.OnVisibilityChanged += OnConfigurationVisibilityChanged;
            collapsibleBody.Margin = new Thickness(10, 0, 0, 0);
            var collapsibleHeader = new CollapsibleHeading();
            collapsibleHeader.MinHeight = 25;
            collapsibleHeader.AddStyleClass(ContainerButton.StyleClassButton);
            collapsibleHeader.AddStyleClass("OpenRight");
            collapsibleHeader.Label.Text = name;
            var collapsible = new Collapsible(collapsibleHeader, collapsibleBody);
            collapsible.Margin = new Thickness(10, 0, 0, 0);
            ConfigurationItemsContainer.AddChild(collapsible);
        }

        public void SwitchMode(InstrumentMidiSourceBase mode)
        {
            _currentMode?.Disable();
            _currentMode = mode;
            _currentMode.Enable();
        }

        public void SetMidiAvailability(bool available)
        {
            UnavailableOverlay.Visible = !available;
        }

        public void SetInstrument(Entity<InstrumentComponent> entity)
        {
            InstrumentSpriteView.SetEntity(entity);
        }
    }
}
