using System.Linq;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Content.Shared.CartridgeLoader.Cartridges;
using Robust.Client.Graphics;
using Robust.Shared.Prototypes;
using Content.Shared.NanoTask.Prototypes;
using System.Diagnostics;

namespace Content.Client.CartridgeLoader.Cartridges;

/// <summary>
///     Class displaying the main UI of NanoTask
/// </summary>
[GenerateTypedNameReferences]
public sealed partial class NanoTaskUiFragment : BoxContainer
{
    public Action<NanoTaskTable, NanoTaskCategoryAndDepartment, uint>? OpenTask;
    public Action<NanoTaskTable, NanoTaskCategoryAndDepartment, uint>? ToggleTaskCompletion;
    public Action<NanoTaskTable, NanoTaskCategoryAndDepartment>? NewTask;

    public NanoTaskUiFragment()
    {
        RobustXamlLoader.Load(this);
        Orientation = LayoutOrientation.Vertical;
        HorizontalExpand = true;
        VerticalExpand = true;

        StationTaskTable.NewTaskButton.OnPressed += _ => NewTask?.Invoke(StationTaskTable, new(NanoTaskCategory.Station, null));

        TabsCategory.SetTabTitle(0, Loc.GetString("nano-task-ui-department-tasks"));
        TabsCategory.SetTabTitle(1, Loc.GetString("nano-task-ui-station-tasks"));
    }

    public void UpdateState(List<NanoTaskItemAndDepartment> tasks, List<ProtoId<NanoTaskDepartmentPrototype>> departments)
    {
        UpdateStationTasksState(tasks.Where(task => task.Category.Category is NanoTaskCategory.Station).ToList());

        UpdateDepartmentTasksState(tasks.Where(task => task.Category.Category is NanoTaskCategory.Department).ToList(), departments);
    }

    private void UpdateDepartmentTasksState(List<NanoTaskItemAndDepartment> tasks, List<ProtoId<NanoTaskDepartmentPrototype>> departments)
    {
        TabsDepartmentTask.RemoveAllChildren();

        var departmentTasks = tasks
            .GroupBy(task => task.Category.Department)
            .OrderBy(group => group.Key)
            .ToList();

        foreach (var (department, index) in departments.Select((d, i) => (d, i)))
        {
            var table = new NanoTaskTable
            {
                Tasks = tasks,
            };
            table.NewTaskButton.OnPressed += _ => NewTask?.Invoke(table, new(NanoTaskCategory.Department, department));

            var groupedTasks = departmentTasks.FirstOrDefault(group => group.Key == department) ?? Enumerable.Empty<NanoTaskItemAndDepartment>();
            foreach (var task in groupedTasks)
            {
                var container = task.Item.Data.Priority switch
                {
                    NanoTaskPriority.High => table.HighContainer,
                    NanoTaskPriority.Medium => table.MediumContainer,
                    NanoTaskPriority.Low => table.LowContainer,
                };
                var control = new NanoTaskItemControl(task);
                container.AddChild(control);
                control.OnMainPressed += id => OpenTask?.Invoke(table, new(NanoTaskCategory.Department, department), id);
                control.OnDonePressed += id => ToggleTaskCompletion?.Invoke(table, new(NanoTaskCategory.Department, department), id);
            }

            var departmentName = IoCManager.Resolve<IPrototypeManager>().Index(department).Name;

            TabsDepartmentTask.AddChild(table);
            TabsDepartmentTask.SetTabTitle(index, Loc.GetString(departmentName));
        }
    }

    private void UpdateStationTasksState(List<NanoTaskItemAndDepartment> tasks)
    {
        TabsCategory.Visible = true;
        ConnectionBox.Visible = false;
        OfflineBox.Visible = false;

        StationTaskTable.Clear();

        StationTaskTable.Tasks = tasks;

        StationTaskTable.HighPriority.HeaderLabel.Text = Loc.GetString("nano-task-ui-heading-high-priority-tasks", ("amount", StationTaskTable.Tasks.Count(task => task.Item.Data.Priority == NanoTaskPriority.High)));
        StationTaskTable.MediumPriority.HeaderLabel.Text = Loc.GetString("nano-task-ui-heading-medium-priority-tasks", ("amount", StationTaskTable.Tasks.Count(task => task.Item.Data.Priority == NanoTaskPriority.Medium)));
        StationTaskTable.LowPriority.HeaderLabel.Text = Loc.GetString("nano-task-ui-heading-low-priority-tasks", ("amount", StationTaskTable.Tasks.Count(task => task.Item.Data.Priority == NanoTaskPriority.Low)));

        foreach (var task in StationTaskTable.Tasks)
        {
            var container = task.Item.Data.Priority switch
            {
                NanoTaskPriority.High => StationTaskTable.HighContainer,
                NanoTaskPriority.Medium => StationTaskTable.MediumContainer,
                NanoTaskPriority.Low => StationTaskTable.LowContainer,
            };
            var control = new NanoTaskItemControl(task);
            container.AddChild(control);
            control.OnMainPressed += id => OpenTask?.Invoke(StationTaskTable, new(NanoTaskCategory.Station, null), id);
            control.OnDonePressed += id => ToggleTaskCompletion?.Invoke(StationTaskTable, new(NanoTaskCategory.Station, null), id);
        }
    }

    public void UpdateStateNoServers()
    {
        TabsCategory.Visible = false;
        ConnectionBox.Visible = false;
        OfflineBox.Visible = true;

        OfflinePanel.PanelOverride = new StyleBoxFlat
        {
            BackgroundColor = Color.Red,
        };
    }
}
