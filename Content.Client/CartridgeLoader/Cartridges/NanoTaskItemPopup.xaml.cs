using System.Linq;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.CustomControls;
using Robust.Client.UserInterface.XAML;
using Robust.Client.UserInterface.Controls;
using Content.Shared.CartridgeLoader.Cartridges;
using Content.Shared.NanoTask;

namespace Content.Client.CartridgeLoader.Cartridges;

/// <summary>
///     Popup displayed to edit a NanoTask item
/// </summary>
[GenerateTypedNameReferences]
public sealed partial class NanoTaskItemPopup : DefaultWindow
{
    private readonly ButtonGroup _priorityGroup = new();
    private uint? _editingTaskId = null;
    private NanoTaskCategory _nanoTaskCategory = NanoTaskCategory.Station;
    private string? _nanoTaskDepartment = null;

    public Action<uint, NanoTaskCategoryAndDepartment, NanoTaskItem>? TaskSaved;
    public Action<uint>? TaskDeleted;
    public Action<NanoTaskCategoryAndDepartment, NanoTaskItem>? TaskCreated;
    public Action<NanoTaskItem>? TaskPrinted;

    private NanoTaskItem MakeItem()
    {
        return new(
            description: DescriptionInput.Text,
            taskIsFor: RequesterInput.Text,
            status: NanoTaskItemStatus.InProgress,
            priority: _priorityGroup.Pressed switch
            {
                var item when item == LowButton => NanoTaskPriority.Low,
                var item when item == MediumButton => NanoTaskPriority.Medium,
                var item when item == HighButton => NanoTaskPriority.High,
                _ => NanoTaskPriority.Medium,
            }
        );
    }

    public NanoTaskItemPopup()
    {
        RobustXamlLoader.Load(this);

        LowButton.Group = _priorityGroup;
        MediumButton.Group = _priorityGroup;
        HighButton.Group = _priorityGroup;

        CancelButton.OnPressed += _ => Close();
        DeleteButton.OnPressed += _ =>
        {
            if (_editingTaskId is uint id)
            {
                TaskDeleted?.Invoke(id);
            }
        };
        SaveButton.OnPressed += _ =>
        {
            if (_editingTaskId is uint id)
            {
                TaskSaved?.Invoke(id, new(_nanoTaskCategory, _nanoTaskDepartment), MakeItem());
            }
            else
            {
                TaskCreated?.Invoke(new(_nanoTaskCategory, _nanoTaskDepartment), MakeItem());
            }
        };

        DescriptionInput.OnTextChanged += args =>
        {
            if (args.Text.Length > NanoTaskItem.MaximumStringLength)
                DescriptionInput.Text = args.Text[..NanoTaskItem.MaximumStringLength];
        };
        RequesterInput.OnTextChanged += args =>
        {
            if (args.Text.Length > NanoTaskItem.MaximumStringLength)
                RequesterInput.Text = args.Text[..NanoTaskItem.MaximumStringLength];
        };
    }

    public void SetEditingTaskId(uint? id)
    {
        _editingTaskId = id;
        DeleteButton.Visible = id is not null;
    }

    public void SetCategory(NanoTaskCategory category, string? name)
    {
        _nanoTaskCategory = category;
        _nanoTaskDepartment = name;
    }

    public void ResetInputs(NanoTaskItem? item)
    {
        if (item is NanoTaskItem task)
        {
            var button = task.Priority switch
            {
                NanoTaskPriority.High => HighButton,
                NanoTaskPriority.Medium => MediumButton,
                NanoTaskPriority.Low => LowButton,
                _ => throw new NotImplementedException(),
            };
            button.Pressed = true;
            DescriptionInput.Text = task.Description;
            RequesterInput.Text = task.TaskIsFor;
        }
        else
        {
            MediumButton.Pressed = true;
            DescriptionInput.Text = "";
            RequesterInput.Text = "";
        }
    }
}
