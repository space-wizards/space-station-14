using Content.Client.UserInterface.Controls;
using Content.Client.UserInterface.Fragments;
using Content.Shared.Mech.Components;
using Content.Shared.Mech;
using Content.Shared.Atmos;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.XAML;
using Robust.Client.UserInterface.Controls;
using System.Linq;
using Robust.Client.UserInterface;
using Content.Shared.Mech.EntitySystems;
using Content.Client.Mech.Ui.Equipment;
using Robust.Shared.IoC;

namespace Content.Client.Mech.Ui;

/// <summary>
/// Interface control for mechs.
/// </summary>
/// <seealso cref="MechBoundUserInterface"/>
[GenerateTypedNameReferences]
public sealed partial class MechMenu : FancyWindow
{
    // Dependencies
    [Dependency] private readonly IEntityManager _entityManager = default!;
    [Dependency] private readonly ILocalizationManager _loc = default!;

    // State
    private EntityUid _mech;
    private bool _hasAccess = false;
    private bool _pilotPresent = false;
    private BoundUserInterface? _parentBui;

    // Events for the BUI to subscribe to
    public event Action<EntityUid>? OnRemoveButtonPressed;
    public event Action<EntityUid>? OnRemoveModuleButtonPressed;

    public event Action<bool>? OnAirtightChanged;
    public event Action<bool>? OnFanToggle;
    public event Action<bool>? OnFilterToggle;
    public event Action? OnDnaLockRegister;
    public event Action? OnDnaLockToggle;
    public event Action? OnDnaLockReset;
    public event Action? OnCardLockRegister;
    public event Action? OnCardLockToggle;
    public event Action? OnCardLockReset;
    public event Action? OnCabinPurge;

    public MechMenu()
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);

        InitializeEventHandlers();
    }

    public void SetEntity(EntityUid entity)
    {
        _mech = entity;

        this.SetInfoFromEntity(_entityManager, _mech);

        MechView.SetEntity(entity);
        MechName.Text = _entityManager.GetComponent<MetaDataComponent>(_mech).EntityName;
    }

    public void SetParentBui(BoundUserInterface parentBui)
    {
        _parentBui = parentBui;
    }

    private void InitializeEventHandlers()
    {
        // Cabin controls with access checks
        AirtightButton.OnToggled += args => OnAirtightChanged?.Invoke(args.Pressed);
        CabinPurgeButton.OnPressed += _ => OnCabinPurge?.Invoke();

        // Fan controls
        FanToggle.StateChanged += isOn => OnFanToggle?.Invoke(isOn);

        // Lock controls
        DnaLockRegisterButton.OnPressed += _ => OnDnaLockRegister?.Invoke();
        DnaLockBlockButton.OnPressed += _ => OnDnaLockToggle?.Invoke();
        DnaLockResetButton.OnPressed += _ => OnDnaLockReset?.Invoke();

        CardLockRegisterButton.OnPressed += _ => OnCardLockRegister?.Invoke();
        CardLockBlockButton.OnPressed += _ => OnCardLockToggle?.Invoke();
        CardLockResetButton.OnPressed += _ => OnCardLockReset?.Invoke();

        // Filter control
        FilterEnabledCheck.OnToggled += args => OnFilterToggle?.Invoke(args.Pressed);
    }

    public void UpdateMechStats()
    {
        if (_lastState != null)
        {
            if (_lastState.MaxIntegrity > 0f)
            {
                            var integrityPercent = _lastState.Integrity / _lastState.MaxIntegrity;
            IntegrityDisplayBar.Value = integrityPercent;

            var integrityText = _lastState.IsBroken
                ? _loc.GetString("mech-integrity-display-broken", ("amount", (int)(integrityPercent * 100)))
                : _loc.GetString("mech-integrity-display", ("amount", (int)(integrityPercent * 100)));

            IntegrityDisplay.Text = integrityText;
            }
            else
            {
                IntegrityDisplayBar.Value = 0f;
                IntegrityDisplay.Text = _loc.GetString("mech-integrity-display", ("amount", 0));
            }

            if (_lastState.MaxEnergy > 0f)
            {
                var energyPercent = _lastState.Energy / _lastState.MaxEnergy;
                EnergyDisplayBar.Value = energyPercent;
                EnergyDisplay.Text = _loc.GetString("mech-energy-display", ("amount", (int)(energyPercent * 100)));
            }
            else
            {
                EnergyDisplayBar.Value = 0f;
                EnergyDisplay.Text = _loc.GetString("mech-energy-missing");
            }

            SlotDisplay.Text = _loc.GetString("mech-equipment-slot-display",
                ("used", _lastState.EquipmentUsed), ("max", _lastState.MaxEquipmentAmount));

            ModuleSlotDisplay.Text = _loc.GetString("mech-module-slot-display",
                ("used", _lastState.ModuleSpaceUsed), ("max", _lastState.ModuleSpaceMax));
        }
    }

    public void UpdateMechState(MechBoundUiState state)
    {
        _lastState = state;
        _pilotPresent = state.PilotPresent;

        var anyLockRegistered = state.DnaLockRegistered || state.CardLockRegistered;
        if (!anyLockRegistered)
            _hasAccess = true;

        FanToggle.Visible = state.HasFanModule;
        FilterEnabledCheck.Visible = state.HasFanModule;
        FanMissingLabel.Visible = !state.HasFanModule;

        CabinPurgeButton.Text = _loc.GetString("mech-cabin-purge");
        CabinPurgeButton.Disabled = !state.CabinPurgeAvailable || !state.CanAirtight;

        AirtightButton.Visible = state.CanAirtight;
        CabinPurgeButton.Visible = state.CanAirtight;
        AirtightUnavailableLabel.Visible = !state.CanAirtight;

        if (AirtightButton.Pressed != state.IsAirtight)
            AirtightButton.Pressed = state.IsAirtight;

        if (state.HasFanModule)
        {
            if (FanToggle.IsOn != state.FanActive)
                FanToggle.IsOn = state.FanActive;

            if (FilterEnabledCheck.Pressed != state.FilterEnabled)
                FilterEnabledCheck.Pressed = state.FilterEnabled;
        }

        // Display temperature in Celsius
        var tempC = Content.Shared.Temperature.TemperatureHelpers.KelvinToCelsius(state.CabinTemperature);

        if (state.CanAirtight)
        {
            CabinPressureLabel.Text = _loc.GetString("mech-cabin-pressure-level", ("level", $"{state.CabinPressureLevel:F1}"));
            CabinTemperatureLabel.Text = _loc.GetString("mech-cabin-temperature-level", ("tempC", $"{tempC:F1}"));
            CabinPressureLabel.FontColorOverride = Color.White;
            CabinTemperatureLabel.FontColorOverride = Color.Orange;
        }
        else
        {
            CabinPressureLabel.Text = _loc.GetString("mech-no-airtight-status");
            CabinTemperatureLabel.Text = _loc.GetString("mech-no-airtight-status");
            CabinPressureLabel.FontColorOverride = Color.Gray;
            CabinTemperatureLabel.FontColorOverride = Color.Gray;
        }

        if (state.HasGasModule)
        {
            TankPressureLabel.Text = _loc.GetString("mech-tank-pressure-level", ("state", "ok"), ("pressure", $"{state.TankPressure:F1}"));
            TankPressureLabel.FontColorOverride = Color.White;
        }
        else
        {
            TankPressureLabel.Text = _loc.GetString("mech-tank-pressure-level", ("state", "na"));
            TankPressureLabel.FontColorOverride = Color.Gray;
        }

        UpdateFanStatusDisplay(state.FanState);
        UpdateLockInfoLabels(state);
        UpdateLockButtons(state);

        // Compare UI children vs new state to decide whether to rebuild
        var currentEquip = EquipmentControlContainer.Children.OfType<MechEquipmentControl>()
            .Select(c => _entityManager.GetNetEntity(c.Entity));
        if (!currentEquip.SequenceEqual(state.Equipment))
            UpdateEquipmentView(state.Equipment);

        var currentMods = ModuleControlContainer.Children.OfType<MechEquipmentControl>()
            .Select(c => _entityManager.GetNetEntity(c.Entity));
        if (!currentMods.SequenceEqual(state.Modules))
            UpdateModuleView(state.Modules);

        // Apply access visibility
        SetAccessVisibility(state.IsLocked);

        // Disable removing only if pilot is present
        SetRemoveDisabledForContainer(EquipmentControlContainer, _pilotPresent);
        SetRemoveDisabledForContainer(ModuleControlContainer, _pilotPresent);

        RefreshEquipmentFragmentStates(state);
    }

    private void UpdateFanStatusDisplay(MechFanState fanState)
    {
        var stateKey = fanState switch
        {
            MechFanState.Off => "off",
            MechFanState.On => "on",
            MechFanState.Idle => "idle",
            _ => "na"
        };
        var stateColorKey = fanState switch
        {
            MechFanState.Off => Color.Red,
            MechFanState.On => Color.Green,
            MechFanState.Idle => Color.Yellow,
            _ => Color.Gray
        };

        FanStatusLabel.Text = _loc.GetString("mech-fan-status", ("state", stateKey));
        FanStatusLabel.FontColorOverride = stateColorKey;
    }

    private void UpdateLockInfoLabels(MechBoundUiState state)
    {
        if (state.DnaLockRegistered && !string.IsNullOrEmpty(state.OwnerDna))
        {
            DnaLockInfoLabel.Text = $"[{state.OwnerDna}]";
        }
        else
        {
            DnaLockInfoLabel.Text = _loc.GetString("mech-lock-not-set");
        }

        if (state.CardLockRegistered && !string.IsNullOrEmpty(state.OwnerJobTitle))
        {
            CardLockInfoLabel.Text = $"[{state.OwnerJobTitle}]";
        }
        else
        {
            CardLockInfoLabel.Text = _loc.GetString("mech-lock-not-set");
        }
    }

    private void UpdateLockButtons(MechBoundUiState state)
    {
        var (dnaRegistered, dnaActive, _) = GetLockState(state, MechLockType.Dna);
        var (cardRegistered, cardActive, _) = GetLockState(state, MechLockType.Card);

        UpdateLockButtonSet(DnaLockRegisterButton, DnaLockBlockButton, DnaLockResetButton, dnaRegistered, dnaActive);
        UpdateLockButtonSet(CardLockRegisterButton, CardLockBlockButton, CardLockResetButton, cardRegistered, cardActive);
    }

    private void UpdateLockButtonSet(Button registerButton, Button blockButton, Button resetButton, bool isRegistered, bool isActive)
    {
        registerButton.Visible = !isRegistered;
        blockButton.Visible = isRegistered;
        resetButton.Visible = isRegistered;
        blockButton.Text = _loc.GetString(isActive ? "mech-lock-deactivate" : "mech-lock-activate");
        blockButton.Pressed = isActive;
    }

    private void SetRemoveDisabledForContainer(Control container, bool disabled)
    {
        foreach (var control in container.Children.OfType<MechEquipmentControl>())
        {
            control.SetRemoveDisabled(disabled);
        }
    }

    private MechBoundUiState? _lastState;

    public void OverrideAccessAndRefresh(bool hasAccess)
    {
        _hasAccess = hasAccess;
        if (_lastState != null)
        {
            SetAccessVisibility(_lastState.IsLocked);
        }
    }

    private void RefreshEquipmentFragmentStates(MechBoundUiState state)
    {
        UpdateFragmentsForContainer(EquipmentControlContainer, state.EquipmentUiStates);
        UpdateFragmentsForContainer(ModuleControlContainer, state.EquipmentUiStates);
    }

    private void UpdateFragmentsForContainer(Control container, Dictionary<NetEntity, BoundUserInterfaceState> states)
    {
        foreach (var control in container.Children.OfType<MechEquipmentControl>())
        {
            var ent = control.Entity;
            var netEnt = _entityManager.GetNetEntity(ent);
            if (!states.TryGetValue(netEnt, out var eqState))
                continue;

            var uicomp = _entityManager.GetComponentOrNull<UIFragmentComponent>(ent);
            if (uicomp?.Ui != null)
            {
                uicomp.Ui.UpdateState(eqState);
            }
        }
    }

    private (bool IsRegistered, bool IsActive, string? OwnerId) GetLockState(MechBoundUiState state, MechLockType lockType)
    {
        return lockType switch
        {
            MechLockType.Dna => (state.DnaLockRegistered, state.DnaLockActive, state.OwnerDna),
            MechLockType.Card => (state.CardLockRegistered, state.CardLockActive, state.OwnerJobTitle),
            _ => (false, false, null)
        };
    }

    private void SetAccessVisibility(bool isLocked)
    {
        var noAccessActive = isLocked && !_hasAccess;
        HaveAccessEquipment.Visible = !noAccessActive;
        HaveAccessSettings.Visible = !noAccessActive;
        NoAccessSettings.Visible = noAccessActive;
        NoAccessEquipment.Visible = noAccessActive;
    }

    public void UpdateEquipmentView(List<NetEntity>? equipment = null)
    {
        if (equipment == null)
        {
            if (!_entityManager.TryGetComponent<MechComponent>(_mech, out var mechComp))
                return;
            equipment = new List<NetEntity>();
            foreach (var ent in mechComp.EquipmentContainer.ContainedEntities)
                equipment.Add(_entityManager.GetNetEntity(ent));
        }

        EquipmentControlContainer.Children.Clear();
        foreach (var netEnt in equipment)
        {
            var ent = _entityManager.GetEntity(netEnt);
            if (!_entityManager.TryGetComponent<MetaDataComponent>(ent, out var metaData))
                continue;

            var uicomp = _entityManager.GetComponentOrNull<UIFragmentComponent>(ent);
            Control? ui = null;

            if (uicomp?.Ui != null)
            {
                uicomp.Ui.Setup(_parentBui!, ent);
                if (_lastState?.EquipmentUiStates.TryGetValue(netEnt, out var eqState) == true)
                {
                    uicomp.Ui.UpdateState(eqState);
                }

                ui = uicomp.Ui.GetUIFragmentRoot();
            }

            // Get equipment size
            var size = _entityManager.GetComponentOrNull<MechEquipmentComponent>(ent)?.Size ?? 1;

            var control = new MechEquipmentControl(ent, metaData.EntityName, ui, size);
            control.OnRemoveButtonPressed += () => OnRemoveButtonPressed?.Invoke(ent);
            EquipmentControlContainer.AddChild(control);
        }
    }

    public void UpdateModuleView(List<NetEntity>? modules = null)
    {
        if (modules == null)
        {
            if (!_entityManager.TryGetComponent<MechComponent>(_mech, out var mechComp))
                return;
            modules = new List<NetEntity>();
            foreach (var ent in mechComp.ModuleContainer.ContainedEntities)
                modules.Add(_entityManager.GetNetEntity(ent));
        }

        ModuleControlContainer.Children.Clear();
        foreach (var netEnt in modules)
        {
            var ent = _entityManager.GetEntity(netEnt);
            if (!_entityManager.TryGetComponent<MetaDataComponent>(ent, out var metaData))
                continue;

            Control? ui = null;
            var uicomp = _entityManager.GetComponentOrNull<UIFragmentComponent>(ent);
            if (uicomp?.Ui != null)
            {
                uicomp.Ui.Setup(_parentBui!, ent);
                if (_lastState?.EquipmentUiStates.TryGetValue(netEnt, out var modState) == true)
                {
                    uicomp.Ui.UpdateState(modState);
                }
                ui = uicomp.Ui.GetUIFragmentRoot();
            }

            // Get module size
            var size = _entityManager.GetComponentOrNull<MechModuleComponent>(ent)?.Size ?? 1;

            var control = new MechEquipmentControl(ent, metaData.EntityName, ui, size);
            control.OnRemoveButtonPressed += () => OnRemoveModuleButtonPressed?.Invoke(ent);
            ModuleControlContainer.AddChild(control);
        }
    }

    /// <summary>
    /// Updates the UI state and refreshes all displays.
    /// </summary>
    public void UpdateState(MechBoundUiState state)
    {
        _lastState = state;
        UpdateMechState(state);
        UpdateMechStats();
    }
}
