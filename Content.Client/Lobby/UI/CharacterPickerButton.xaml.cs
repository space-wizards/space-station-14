using System.Linq;
using Content.Client.Humanoid;
using Content.Shared.Clothing;
using Content.Shared.Humanoid;
using Content.Shared.Humanoid.Prototypes;
using Content.Shared.Preferences;
using Content.Shared.Preferences.Loadouts;
using Content.Shared.Roles;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Map;
using Robust.Shared.Player;
using Robust.Shared.Prototypes;

namespace Content.Client.Lobby.UI;

/// <summary>
/// Holds character data on the side of the setup GUI.
/// </summary>
[GenerateTypedNameReferences]
public sealed partial class CharacterPickerButton : ContainerButton
{
    /// <summary>
    /// Invoked if we should delete the attached character
    /// </summary>
    public event Action? OnDeletePressed;

    /// <summary>
    /// Create a new character picker button
    /// </summary>
    /// <param name="entityManager">Passed in dependency</param>
    /// <param name="prototypeMan">Passed in dependency</param>
    /// <param name="group">Button group to join</param>
    /// <param name="profile">Profile this button is attached to</param>
    /// <param name="isSelected">If true, start in pressed state</param>
    /// <param name="readOnly">If true, don't show delete button (used for late join gui)</param>
    public CharacterPickerButton(
        IPrototypeManager prototypeManager,
        ISharedPlayerManager playerMan,
        ButtonGroup group,
        HumanoidCharacterProfile profile,
        bool isSelected,
        bool readOnly = false)
    {
        RobustXamlLoader.Load(this);
        AddStyleClass(StyleClassButton);
        ToggleMode = true;
        Group = group;
        var description = profile.Name;

        View.LoadPreview(profile);

        var highPriorityJob = profile.JobPriorities.SingleOrDefault(p => p.Value == JobPriority.High).Key;
        if (highPriorityJob != default)
        {
            var jobName = prototypeManager.Index(highPriorityJob).LocalizedName;
            description = $"{description}\n{jobName}";
        }

        Pressed = isSelected;
        DeleteButton.Visible = !isSelected;

        DescriptionLabel.Text = description;

        if (readOnly)
        {
            DeleteButton.Visible = false;
        }
        else
        {
            ConfirmDeleteButton.OnPressed += _ =>
            {
                Parent?.RemoveChild(this);
                Parent?.RemoveChild(ConfirmDeleteButton);
                OnDeletePressed?.Invoke();
            };

            DeleteButton.OnPressed += _ =>
            {
                DeleteButton.Visible = false;
                ConfirmDeleteButton.Visible = true;
            };
        }
    }
}
