using System.ComponentModel;
using System.Threading.Tasks;
using Content.Client.Sprite;
using Content.Shared.Humanoid;
using Content.Shared.Preferences;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Client.Utility;
using Robust.Shared.Player;
using Robust.Shared.Prototypes;

namespace Content.Client.Lobby.UI.ProfileEditorControls;

/// <summary>
/// This class provides a control that gives you a sprite view of an entity with an applied
/// <see cref="HumanoidCharacterProfile"/>, and some buttons to rotate the view. It's a relatively lightweight wrapper
/// around <see cref="ProfilePreviewSpriteView"/> specifically for the right side panel of the
/// <see cref="HumanoidProfileEditor"/> window.
/// </summary>
[GenerateTypedNameReferences]
public sealed partial class ProfilePreview : BoxContainer
{
    private IEntityManager _entityManager = default!;

    private HumanoidProfileEditor? _editor;

    private Direction _previewRotation = Direction.North;

    public ProfilePreview()
    {
        RobustXamlLoader.Load(this);
        SpriteRotateLeft.OnPressed += OnRotateLeft;
        SpriteRotateRight.OnPressed += OnRotateRight;
    }

    /// <summary>
    /// This MUST be called before loading a profile to initialize the managers.
    /// Instead of resolving these dependencies, we pass the references through.
    /// </summary>
    /// <param name="profileEditor">Passed in dependency</param>
    /// <param name="entMan">Passed in dependency</param>
    /// <param name="prefMan">Passed in dependency</param>
    /// <param name="protoMan">Passed in dependency</param>
    /// <param name="playerMan">Passed in dependency</param>
    public void Initialize(HumanoidProfileEditor profileEditor, IEntityManager entMan, IClientPreferencesManager prefMan, IPrototypeManager protoMan, ISharedPlayerManager playerMan)
    {
        _editor = profileEditor;
        _entityManager = entMan;
        SpriteView.Initialize(prefMan, protoMan, playerMan);
    }

    private void OnRotateLeft(BaseButton.ButtonEventArgs obj)
    {
        _previewRotation = _previewRotation.TurnCw();
        SetPreviewRotation(_previewRotation);
    }

    private void OnRotateRight(BaseButton.ButtonEventArgs obj)
    {
        _previewRotation = _previewRotation.TurnCcw();
        SetPreviewRotation(_previewRotation);
    }

    private void SetPreviewRotation(Direction direction)
    {
        if (direction == Direction.Invalid)
            throw new Exception("Invalid direction");
        // I didn't write this code but it's pretty wacky...
        // It looks like OnRotateLeft/Right will increment or decrement the direction of _previewRotation, which includes
        // all 8 directions, but then this function basically truncates that to four directions, and multiplies by two
        // in order to get the sprite to rotate in 90 degree increments instead of 45 degree increments.
        // It's pretty wacky like I said but I'm not inclined to change code that works right now.
        SpriteView.OverrideDirection = (Direction) ((int) direction % 4 * 2);
    }

    /// <summary>
    /// Reloads the entire dummy entity for preview.
    /// This will reload the job profiles and delete and reconstruct the entity from scratch.
    /// </summary>
    /// <remarks>
    /// This is expensive so not recommended to run if you have a slider.
    /// </remarks>
    public void ReloadPreview()
    {
        if (_editor?.Profile == null)
            return;

        SpriteView.LoadPreview(_editor.Profile, _editor?.JobOverride, _editor?.ShouldShowClothes ?? true);
    }

    /// <summary>
    /// A slim reload that only updates the entity itself and not any of the job entities, etc.
    /// This just updates the elements of the entity that can be found in <see cref="HumanoidAppearanceComponent"/>.
    /// Use this for skin color, markings updates, etc.
    /// </summary>
    public void ReloadProfilePreview()
    {
        if (_editor?.Profile == null)
            return;

        SpriteView.ReloadProfilePreview(_editor.Profile);
    }

    /// <summary>
    /// This is task that will initiate an image export of the current entity. Optionally disable a UI button for a half
    /// second for feedback.
    /// </summary>
    /// <param name="buttonToDisable">If specified, this button will be disabled for at least a half second.</param>
    public async void ExportImage(BaseButton? buttonToDisable = null)
    {
        var dir = SpriteView.OverrideDirection ?? Direction.South;

        var tasks = new List<Task>();

        // If we're given a button to momentarily disable for feedback, disable the button and add a delay task to
        // the list
        if(buttonToDisable is not null)
        {
            tasks.Add(Task.Delay(TimeSpan.FromSeconds(0.5f)));
            buttonToDisable.Disabled = true;
        }

        // Add the export task to the list
        tasks.Add(_entityManager.System<ContentSpriteSystem>().Export(SpriteView.PreviewDummy, dir, includeId: false));

        // Wait for the export task and the optional delay task
        await Task.WhenAll(tasks);

        // Now re-enable the button
        if(buttonToDisable is not null)
            buttonToDisable.Disabled = false;
    }
}
