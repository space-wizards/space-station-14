using Content.Client.Resources;
using Robust.Client.AutoGenerated;
using Robust.Client.Graphics;
using Robust.Client.ResourceManagement;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.CustomControls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Map;
using Robust.Shared.Prototypes;
using Robust.Shared.Utility;


namespace Content.Client.Lobby.UI.Loadouts;

/// <summary>
/// A button that toggles the loadout groups. Needs for override default styles.
/// </summary>
[GenerateTypedNameReferences]
public sealed partial class ChildLoadoutGroupHeader : BoxContainer
{
    [Dependency] private readonly IResourceCache _resCache = default!;
    [Dependency] private readonly IEntityManager _entManager = default!;

    public const string StyleClassButton = "button";
    public const string StylePropertyIconColor = "IconColor";
    public const string StylePropertyIconExpanded = "IconExpanded";
    public const string StylePropertyIconCollapsed = "IconCollapsed";
    public const string DefaultIconExpanded = "/Textures/Interface/Nano/inverted_triangle.svg.png";
    public const string DefaultIconCollapsed = "/Textures/Interface/Nano/triangle_right.png";
    public Color IconColor = Color.White;
    public Texture? IconExpanded;
    public Texture? IconCollapsed;

    private readonly EntityUid? _entity;

    public ContainerButton Button => ToggleButton;

    public void SetExpanded(bool expanded)
    {
        Button.Pressed = expanded;
        DropdownArrow.Texture = Button.Pressed ? IconExpanded : IconCollapsed;
    }

    public ChildLoadoutGroupHeader(string displayName, string displayDescription, EntProtoId? displayDummy)
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);

        Button.AddStyleClass(StyleClassButton);

        LoadIcons();
        SetExpanded(false);

        Label.Text = displayName;

        if (displayDummy == null)
            return;

        _entity = _entManager.SpawnEntity(displayDummy, MapCoordinates.Nullspace);
        Sprite.SetEntity(_entity);

        var spriteTooltip = new Tooltip();
        spriteTooltip.SetMessage(FormattedMessage.FromUnformatted(displayDescription));

        TooltipSupplier = _ => spriteTooltip;
    }

    private void LoadIcons()
    {
        IconColor = TryGetStyleProperty(StylePropertyIconColor, out Color color) ? color : Color.White;

        if (!TryGetStyleProperty(StylePropertyIconExpanded, out IconExpanded))
            IconExpanded = _resCache.GetTexture(DefaultIconExpanded);

        if (!TryGetStyleProperty(StylePropertyIconCollapsed, out IconCollapsed))
            IconCollapsed = _resCache.GetTexture(DefaultIconCollapsed);
    }

    protected override void Dispose(bool disposing)
    {
        base.Dispose(disposing);
        if (!disposing)
            return;

        _entManager.DeleteEntity(_entity);
    }
}
