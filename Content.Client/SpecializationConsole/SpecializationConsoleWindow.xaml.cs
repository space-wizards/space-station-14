using System.Linq;
using Content.Client.Lobby;
using Content.Client.UserInterface.Controls;
using Content.Shared.Access.Components;
using Content.Shared.Access.Systems;
using Content.Shared.CCVar;
using Content.Shared.Dataset;
using Content.Shared.Preferences;
using Content.Shared.Random.Helpers;
using Content.Shared.Roles;
using Content.Shared.SpecializationConsole;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Configuration;
using Robust.Shared.Prototypes;
using Robust.Shared.Random;

namespace Content.Client.SpecializationConsole;

[GenerateTypedNameReferences]
public sealed partial class SpecializationConsoleWindow : FancyWindow
{
    [Dependency] private readonly IEntityManager _entManager = default!;
    [Dependency] private readonly IPrototypeManager _prototype = default!;
    [Dependency] private readonly IUserInterfaceManager _userInterfaceManager = default!;
    [Dependency] private readonly IConfigurationManager _configurationManager = default!;
    [Dependency] private readonly IRobustRandom _random = default!;
    private readonly AccessReaderSystem _accessReader;

    private static readonly ProtoId<LocalizedDatasetPrototype> SpecializationPlaceholders = "SpecializationPlaceholders";

    private EntityUid? _dummy;
    private EntityUid? _owner;
    private HumanoidCharacterProfile? _profile;
    private ProtoId<JobPrototype>? _job;
    private string? _spec;

    public event Action<string>? OnSpecializationChanged;
    private readonly int _maxLength;

    public SpecializationConsoleWindow()
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);
        _accessReader = _entManager.System<AccessReaderSystem>();

        _maxLength = _configurationManager.GetCVar(CCVars.MaxJobSpecLength);

        CloseButton.OnPressed += _ => Close();

        SpecializationLineEdit.IsValid = s => s.Length <= _maxLength;
        SpecializationLineEdit.OnTextEntered += e => OnSpecializationChanged?.Invoke(e.Text);
        SpecializationLineEdit.OnTextEntered += SpecializationChanged;

        var placeholders = _prototype.Index(SpecializationPlaceholders);
        var placeholder = Loc.GetString(_random.Pick(placeholders));
        SpecializationLineEdit.PlaceHolder = placeholder;
    }

    public void SetEntity(EntityUid uid, SpriteView sprite) => sprite.SetEntity(uid);

    public void ClearEntity(SpriteView sprite) => sprite.SetEntity(null);

    public void SetOwner(EntityUid owner) => _owner = owner;

    private void SpecializationChanged(LineEdit.LineEditEventArgs args)
    {
        if (args.Text.Length > _maxLength) // Never should be true.
            return;
        var spec = args.Text;
        _spec = spec;

        EmployeeInfo.SetJobSpec(_spec);
    }

    public void UpdateState(SpecializationConsoleBoundInterfaceState state)
    {
        EntityUid? privilegedItem;
        EntityUid? targetItem;
        AccessBox.DisposeAllChildren();
        EmployeeInfo.EntityViewBox.DisposeAllChildren();
        SpecializationLineEdit.Editable = false;
        SpecializationLineEdit.Text = string.Empty;

        if (!_entManager.TryGetComponent<SpecializationConsoleComponent>(_owner, out var specializationConsole))
            return;
        if (specializationConsole.PrivilegedIdSlot.Item is { Valid: true } item)
        {
            privilegedItem = item;
            SetEntity(privilegedItem.Value, EntityView);

            if (!_entManager.TryGetComponent<IdCardComponent>(privilegedItem, out var idCard))
                return;

            foreach (var department in idCard.JobDepartments)
            {
                var departmentLabel = new RichTextLabel();
                departmentLabel.SetMessage($"[{department.Id}]");
                if (specializationConsole.TargetIdSlot.Item is { Valid: true } target)
                {
                    var haveAccess = HaveAccess(privilegedItem.Value, target);
                    if (haveAccess)
                        departmentLabel.Modulate = Color.LimeGreen;
                    else
                        departmentLabel.Modulate = Color.IndianRed;
                }
                AccessBox.AddChild(departmentLabel);
            }
        }
        else
        {
            ClearEntity(EntityView);
            privilegedItem = null;
        }

        if (specializationConsole.TargetIdSlot.Item is { Valid: true } tItem)
        {
            targetItem = tItem;
            _job = state.Job;
            _profile = state.Profile;
            _spec = state.TargetIdJobSpec;

            if (_job != null && _prototype.TryIndex(_job, out var jobProto))
                _dummy = _userInterfaceManager.GetUIController<LobbyUIController>().LoadProfileEntity(_profile, jobProto, true);
            else if (_profile is null)
                _dummy = _entManager.Spawn("PlushieLizard"); // funny in NanoTrasen console?!?! UNACCEPTABLY!

            SetEntity(targetItem.Value, TargetEntityView);
            if (_spec != null)
                SpecializationLineEdit.Text = _spec;

            EmployeeInfo.SetInfo(state.TargetIdFullName, state.TargetIdJobTitle, _spec);
            EmployeeInfo.SetSprite(_dummy);
        }
        else
        {
            ClearEntity(TargetEntityView);
            targetItem = null;

            EmployeeInfo.SetSprite(null);
            EmployeeInfo.SetInfo(null, null, null);
        }

        if (privilegedItem != null && targetItem != null)
            SpecializationLineEdit.Editable = HaveAccess(privilegedItem.Value, targetItem.Value);
    }

    private bool HaveAccess(EntityUid privilegedItem, EntityUid targetItem)
    {
        var privilegedTags = _accessReader.FindAccessTags(privilegedItem);
        var targetTags = _accessReader.FindAccessTags(targetItem);
        var privilegedDepartments = new List<ProtoId<DepartmentPrototype>>();
        var targetDepartments = new List<ProtoId<DepartmentPrototype>>();

        if (_entManager.TryGetComponent<IdCardComponent>(privilegedItem, out var privCard))
            privilegedDepartments = privCard.JobDepartments.ToList();
        if (_entManager.TryGetComponent<IdCardComponent>(targetItem, out var targetCard))
            targetDepartments = targetCard.JobDepartments.ToList();

        if (privilegedTags.Contains("CentralCommand"))
            return true;
        if (targetTags.Contains("CentralCommand"))
            return false;

        // if there is no intersecting departments (captain and hop can edit anyone's specialization, exclude them) -> return false
        foreach (var dep in privilegedDepartments)
        {
            if (dep == "Command" || privilegedTags.Contains("Captain") || privilegedTags.Contains("HeadOfPersonnel"))
                continue;
            if (!targetDepartments.Contains(dep))
                return false;
        }

        // You can't edit command job specialization if you haven't captain or hop access
        // & you can't edit captain specialization if you're not a captain or CC
        if (targetTags.Contains("Command") &&
            !privilegedTags.Contains("Captain") &&
            !privilegedTags.Contains("HeadOfPersonnel") ||
            targetTags.Contains("Captain") && !privilegedTags.Contains("Captain"))
            return false;

        // if there is intersecting tags excluding maintenance and external between command and target -> return true;
        if (privilegedTags.Contains("Command"))
        {
            foreach (var tag in privilegedTags)
            {
                if (tag == "Maintenance" || tag == "External")
                    continue;

                if (targetTags.Contains(tag))
                    return true;
            }
        }
        return false;
    }
}
