using System.Numerics;
using Content.Client.Stylesheets;
using Content.Client.UserInterface.Controls;
using Content.Shared.Implants;
using Content.Shared.StatusIcon;
using Robust.Client.AutoGenerated;
using Robust.Client.GameObjects;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Prototypes;
using Robust.Shared.Timing;

namespace Content.Client.Implants.UI;

[GenerateTypedNameReferences]
public sealed partial class ChameleonControllerMenu : FancyWindow
{
    [Dependency] private readonly IPrototypeManager _prototypeManager = default!;
    [Dependency] private readonly IEntityManager _entityManager = default!;
    private readonly SpriteSystem _sprite;

    // List of all the job protos that you can select!
    private IEnumerable<ChameleonOutfitPrototype> _outfits;

    // Lock the UI until this time
    public DateTime? _lockedUntil;

    private static readonly ProtoId<JobIconPrototype> UnknownIcon = "JobIconUnknown";

    public event Action<ProtoId<ChameleonOutfitPrototype>>? OnJobSelected;

    public ChameleonControllerMenu()
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);
        _sprite = _entityManager.System<SpriteSystem>();

        _outfits = _prototypeManager.EnumeratePrototypes<ChameleonOutfitPrototype>();

        UpdateGrid();
    }

    /// <summary>
    ///     Fill the grid with the correct job icons and buttons.
    /// </summary>
    /// <param name="disabled">Set to true to disable all the buttons.</param>
    public void UpdateGrid(bool disabled = false)
    {
        Grid.RemoveAllChildren();

        foreach (var outfit in _outfits)
        {
            _prototypeManager.TryIndex(outfit.Job, out var jobProto);

            var name = outfit.LoadoutName ?? outfit.Name ?? jobProto?.Name ?? "Prototype has no name or job.";

            var jobIconId = outfit.Icon ?? jobProto?.Icon ?? UnknownIcon;
            var jobIconProto = _prototypeManager.Index(jobIconId);

            var boxContainer = new BoxContainer();

            var button = new Button
            {
                HorizontalExpand = true,
                StyleClasses = {StyleBase.ButtonSquare},
                ToolTip = Loc.GetString(name),
                Text = Loc.GetString(name),
                Margin = new Thickness(0, 0, 15, 0),
                Disabled = disabled,
            };

            var jobIconTexture = new TextureRect
            {
                Texture = _sprite.Frame0(jobIconProto.Icon),
                TextureScale = new Vector2(2.5f, 2.5f),
                Stretch = TextureRect.StretchMode.KeepCentered,
                Margin = new Thickness(0, 0, 5, 0),
            };

            boxContainer.AddChild(jobIconTexture);
            boxContainer.AddChild(button);

            button.OnPressed += _ => JobButtonPressed(outfit.ID);

            Grid.AddChild(boxContainer);
        }
    }

    private void JobButtonPressed(ProtoId<ChameleonOutfitPrototype> outfit)
    {
        OnJobSelected?.Invoke(outfit);
    }

    protected override void FrameUpdate(FrameEventArgs args)
    {
        base.FrameUpdate(args);

        if (_lockedUntil == null || DateTime.Now < _lockedUntil)
            return;

        _lockedUntil = null;
        UpdateGrid();
    }
}
