using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.CustomControls;
using Robust.Client.UserInterface.XAML;

namespace Content.Client.Atmos.UI;

[GenerateTypedNameReferences]
public sealed partial class GasTankWindow : DefaultWindow
{
    public event Action? ToggleInternalsPressed;
    public event Action<float>? OnSetPressure;
    public event Action<bool>? OnToggleValvePressed;

    private float _currentPressure;
    private bool _internalsConnected;

    public GasTankWindow()
    {
        RobustXamlLoader.Load(this);

        InternalsButton.OnPressed += OnToggleInternals;
        LeftButton.OnPressed += LeftButtonPressed;
        RightButton.OnPressed += RightButtonPressed;
        FloatDisplay.OnTextEntered += OnFloatEnteredOrExited;
        FloatDisplay.OnFocusExit += OnFloatEnteredOrExited;
        ReleaseValveClose.OnPressed += OnToggleValve;
        ReleaseValveOpen.OnPressed += OnToggleValve;
    }

    public void UpdateDisplay(float pressure, double airPressure, bool valve, bool internalsConnected)
    {
        _currentPressure = pressure;
        _internalsConnected = internalsConnected;
        FloatDisplay.Text = pressure.ToString("F1");
        PressureLabel.Text = Loc.GetString("gas-tank-window-tank-pressure-text", ("tankPressure", airPressure.ToString("F1")));

        InternalsButton.Text = internalsConnected
            ? Loc.GetString("gas-tank-window-internal-connected")
            : Loc.GetString("gas-tank-window-internal-disconnected");

        if (valve)
        {
            ReleaseValveClose.Disabled = false;
            ReleaseValveOpen.Disabled = true;
        }
        else
        {
            ReleaseValveClose.Disabled = true;
            ReleaseValveOpen.Disabled = false;
        }
    }

    private void OnToggleInternals(BaseButton.ButtonEventArgs args)
    {
        ToggleInternalsPressed?.Invoke();
    }

    private void LeftButtonPressed(BaseButton.ButtonEventArgs args)
    {
        OnSetPressure?.Invoke(_currentPressure - 0.3f);
    }

    private void RightButtonPressed(BaseButton.ButtonEventArgs args)
    {
        OnSetPressure?.Invoke(_currentPressure + 0.3f);
    }

    private void OnFloatEnteredOrExited(LineEdit.LineEditEventArgs args)
    {
        if (float.TryParse(args.Text, out var pressure))
            OnSetPressure?.Invoke(pressure);
        else
            FloatDisplay.Text = _currentPressure.ToString("F1");
    }

    private void OnToggleValve(BaseButton.ButtonEventArgs args)
    {
        OnToggleValvePressed?.Invoke(!_internalsConnected);
    }
}
